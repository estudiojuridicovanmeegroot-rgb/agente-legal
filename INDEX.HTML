<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema Van Meegroot | Gesti√≥n Jur√≠dica</title>
    
    <!-- Configuraci√≥n para M√≥viles (PWA) -->
    <meta name="theme-color" content="#f3f4f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest-placeholder">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/924/924915.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/924/924915.png">

    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase (Base de Datos) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Configuraci√≥n de Dise√±o (Tailwind) -->
    <script>
        tailwind.config = {
            theme: { 
                extend: {
                    colors: { brand: { light: '#e11d48', DEFAULT: '#9f1239', dark: '#881337', surface: '#fff1f2' } },
                    fontFamily: { sans: ['"Inter"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'], display: ['"Cinzel"', 'serif'] },
                    boxShadow: { 'soft': '0 20px 40px -10px rgba(0,0,0,0.05)', 'glow': '0 0 20px rgba(159, 18, 57, 0.25)', 'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02)' }
                }
            }
        }
    </script>

    <!-- Estilos Personalizados -->
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; color: #1f2937; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .hidden { display: none !important; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        
        /* Efectos Visuales */
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .loader { border: 2px solid #f3f4f6; border-top-color: #9f1239; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Navegaci√≥n y Botones */
        .nav-pill.active { color: #fff; background: linear-gradient(135deg, #9f1239, #be123c); box-shadow: 0 4px 12px rgba(159,18,57,0.25); font-weight: 600; }
        .cal-day.today { background: #1f2937; color: white; font-weight: 700; }
        .cal-day.holiday { color: #9f1239; font-weight: 700; background: #fff1f2; }
        .holiday-dot { width: 4px; height: 4px; background: #9f1239; border-radius: 50%; position: absolute; bottom: 6px; }
        
        /* Microfono Justina */
        .voice-active { animation: pulse-red 1.5s infinite; color: #fb7185 !important; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* Componentes Varios */
        .spotlight-item:hover { background: #f8fafc; }
        .cafe-card { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fcd34d; color: #92400e; }
        .input-std { width: 100%; padding: 0.75rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .input-std:focus { background-color: #ffffff; outline: none; border-color: #9f1239; ring: 2px solid rgba(159,18,57,0.1); }
        .label-sm { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-left: 0.25rem; margin-bottom: 0.25rem; display: block; }
        .btn-primary { background-color: #1f2937; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #111827; }
        .btn-brand { background-color: #9f1239; color: white; transition: all 0.2s; }
        .btn-brand:hover { background-color: #881337; }
        .tab-btn-internal.active { background-color: #f1f5f9; color: #1e293b; }
        .tab-btn-internal { color: #94a3b8; }
        .conflict-alert { font-size: 0.75rem; color: #d97706; background-color: #fffbeb; padding: 0.5rem; border-radius: 0.5rem; margin-top: 0.25rem; display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-600 bg-slate-100">

    <!-- Notificaciones Flotantes -->
    <div id="toast-container"></div>

    <!-- PANTALLA LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900">
        <div class="bg-white/95 backdrop-blur-xl p-12 rounded-[2rem] shadow-2xl max-w-md w-full text-center relative overflow-hidden z-10 animate-fade-in border border-white/20">
            <div class="w-20 h-20 bg-gradient-to-br from-brand to-brand-dark text-white rounded-full flex items-center justify-center text-3xl font-display font-bold mx-auto mb-6 shadow-glow border-4 border-white">VM</div>
            <h1 class="text-4xl font-serif font-bold text-slate-900 mb-2">Van Meegroot</h1>
            <p class="text-[10px] font-bold text-brand uppercase tracking-[0.4em] mb-10">Sistema Integral</p>
            <div class="space-y-5 text-left">
                <div><label class="text-[10px] font-bold uppercase text-slate-400">Usuario</label><input id="login-email" type="email" class="w-full px-5 py-4 bg-slate-50 border-gray-200 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-brand" placeholder="ejemplo@estudio.com"></div>
                <div><label class="text-[10px] font-bold uppercase text-slate-400">Contrase√±a</label><div class="relative"><input id="login-pass" type="password" class="w-full px-5 py-4 bg-slate-50 border-gray-200 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-brand pr-12" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') window.App.Auth.login()"><button onclick="window.App.Utils.togglePass('login-pass')" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-brand p-2"><i class="fa-regular fa-eye"></i></button></div></div>
            </div>
            <button onclick="window.App.Auth.login()" class="w-full btn-primary py-4 mt-8 rounded-2xl font-bold text-sm flex justify-center gap-2"><span>Ingresar</span><div id="loader-ingresar" class="loader w-4 h-4 hidden border-white/30 border-t-white"></div></button>
            <div class="mt-8 flex justify-center gap-6 text-xs font-medium text-slate-500"><button onclick="window.App.Auth.register()" class="hover:text-brand">Crear cuenta</button><span>|</span><button onclick="window.App.Auth.guest()" class="hover:text-slate-800">Modo Invitado</button></div>
        </div>
    </div>

    <!-- PANTALLA PRINCIPAL DE LA APP -->
    <div id="app-screen" class="hidden flex-1 flex flex-col h-full bg-[#f3f4f6]">
        <!-- Barra Superior (Header) -->
        <header class="sticky top-0 z-30 pt-4 px-4 pb-2 bg-[#f3f4f6]">
            <div class="glass rounded-full shadow-sm px-6 py-2 flex flex-col lg:flex-row justify-between items-center max-w-[1600px] mx-auto border border-white">
                <div class="flex w-full lg:w-auto justify-between items-center mb-2 lg:mb-0 gap-6">
                    <div class="flex items-center gap-3 shrink-0"><div class="w-9 h-9 rounded-full bg-slate-800 text-white flex items-center justify-center font-display font-bold text-lg border-2 border-white">V</div><div class="hidden sm:block"><h1 class="text-lg font-serif font-bold text-slate-800 leading-none">Van Meegroot</h1></div></div>
                    
                    <!-- BUSCADOR GLOBAL MEJORADO -->
                    <div class="relative flex-1 max-w-lg mx-auto z-50">
                        <div class="relative group">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand transition"></i>
                            <input id="global-search" onkeyup="window.App.Utils.globalSearch()" class="w-full pl-9 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-medium focus:ring-2 focus:ring-brand focus:bg-white transition shadow-sm" placeholder="Buscar expediente, cliente, tarea, evento...">
                            <button onclick="window.App.Utils.clearSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500"><i class="fa-solid fa-times-circle"></i></button>
                        </div>
                        <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl border border-slate-100 max-h-[400px] overflow-y-auto z-[100] p-2 divide-y divide-slate-50">
                            <!-- Resultados din√°micos aqu√≠ -->
                        </div>
                    </div>

                    <div class="flex items-center gap-2 lg:ml-6 shrink-0">
                        <button onclick="window.App.Data.listen()" class="hidden md:flex bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase items-center gap-2 hover:bg-slate-50"><i class="fa-solid fa-rotate text-brand"></i> Sync</button>
                        <p id="user-email-display" class="hidden md:block text-xs font-bold text-slate-500 mr-2"></p>
                        <button onclick="window.App.UI.toggleConfig()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white text-slate-400 hover:text-slate-800 transition"><i class="fa-solid fa-gear"></i></button>
                        <button onclick="window.App.Auth.logout()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-brand-surface text-slate-400 hover:text-brand transition"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
                <!-- Barra de Navegaci√≥n (Pesta√±as) -->
                <div class="w-full lg:w-auto overflow-x-auto scrollbar-hide py-1 mt-2">
                    <nav class="flex gap-1 min-w-max p-1 bg-slate-100/50 rounded-full border border-slate-200/50 justify-center">
                        <button onclick="window.App.UI.changeTab('inicio')" id="btn-inicio" class="nav-pill active px-5 py-2 flex items-center gap-2"><i class="fa-solid fa-chart-pie"></i> <span class="hidden sm:inline">Inicio</span></button>
                        <button onclick="window.App.UI.changeTab('casos')" id="btn-casos" class="nav-pill px-5 py-2 flex items-center gap-2"><i class="fa-solid fa-folder-open"></i> Expedientes</button>
                        <button onclick="window.App.UI.changeTab('agenda')" id="btn-agenda" class="nav-pill px-5 py-2 flex items-center gap-2"><i class="fa-regular fa-calendar"></i> Agenda</button>
                        <button onclick="window.App.UI.changeTab('tareas')" id="btn-tareas" class="nav-pill px-5 py-2 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Tareas</button>
                        <button onclick="window.App.UI.changeTab('contactos')" id="btn-contactos" class="nav-pill px-5 py-2 flex items-center gap-2"><i class="fa-solid fa-users"></i> Directorio</button>
                        <button onclick="window.App.UI.changeTab('links')" id="btn-links" class="nav-pill px-5 py-2 flex items-center gap-2"><i class="fa-solid fa-book-bookmark"></i> Recursos</button>
                        <button onclick="window.App.UI.openCalendar()" class="nav-pill px-5 py-2 flex items-center gap-2 text-brand hover:bg-white"><i class="fa-solid fa-calendar-days"></i> Calc.</button>
                    </nav>
                </div>
            </div>
            
            <!-- Popup Configuraci√≥n -->
            <div id="config-popup" class="hidden absolute top-20 right-8 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 p-6 z-[60] animate-fade-in">
                <h4 class="text-sm font-bold text-slate-800 mb-4 font-serif">Configuraci√≥n</h4>
                <div id="connection-status" class="text-xs p-2 bg-slate-50 rounded-lg mb-4 font-medium">Verificando...</div>
                <div class="relative mb-4"><input type="password" id="gemini-key-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs pr-10" placeholder="Google Gemini API Key..."><button onclick="window.App.Utils.togglePass('gemini-key-input')" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"><i class="fa-regular fa-eye"></i></button></div>
                <button onclick="window.App.IA.testConnection()" class="w-full bg-slate-50 border border-slate-200 py-2 rounded-xl text-[10px] font-bold mb-4 hover:bg-slate-100">Probar IA (Justina)</button>
                <div class="pt-4 border-t border-slate-100"><button onclick="window.App.Data.backup()" class="w-full bg-slate-800 text-white py-3 rounded-xl text-xs font-bold hover:bg-slate-700 flex justify-center gap-2"><i class="fa-solid fa-download"></i> Backup JSON</button></div>
                <div class="flex justify-end mt-4"><button onclick="window.App.UI.saveConfig()" class="bg-brand text-white px-6 py-2 rounded-xl text-xs font-bold shadow-lg">Guardar</button></div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="flex-1 overflow-hidden flex max-w-[1600px] mx-auto w-full pt-4">
            <div class="flex-1 overflow-y-auto px-6 pb-20 relative custom-scrollbar w-full h-full">
                
                <!-- PESTA√ëA: INICIO (DASHBOARD) -->
                <div id="tab-inicio" class="tab-content space-y-6 animate-fade-in pb-10">
                    <div class="w-full max-w-2xl mx-auto mb-6">
                        <!-- Barra de IA Justina -->
                        <div class="flex gap-2 items-center mb-2">
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-1.5 rounded-2xl shadow-xl flex items-center flex-1">
                                <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center shrink-0"><i class="fa-solid fa-wand-magic-sparkles text-amber-400 text-sm"></i></div>
                                <input id="justina-input" class="bg-transparent border-none text-white w-full px-4 text-sm focus:ring-0 placeholder:text-slate-400 placeholder:italic" placeholder="Justina: 'Agendar audiencia ma√±ana a las 10', 'Recordar llamar a L√≥pez'..." onkeydown="if(event.key==='Enter') window.App.IA.processCommand()">
                                <button onclick="window.App.IA.toggleVoice()" class="w-10 h-10 rounded-full hover:bg-white/10 text-slate-300 flex items-center justify-center shrink-0 mr-1"><i id="justina-mic-icon" class="fa-solid fa-microphone"></i></button>
                                <button onclick="window.App.IA.processCommand()" class="w-10 h-10 rounded-full bg-brand hover:bg-brand-light text-white flex items-center justify-center shrink-0"><i id="justina-icon" class="fa-solid fa-arrow-right"></i><div id="justina-loader" class="loader w-4 h-4 border-white/30 border-t-white hidden"></div></button>
                            </div>
                            <button onclick="window.App.IA.morningBrief()" class="w-12 h-12 rounded-2xl bg-amber-100 hover:bg-amber-200 text-amber-600 flex items-center justify-center shadow-sm shrink-0 border border-amber-200" title="Caf√© de la Ma√±ana"><i class="fa-solid fa-mug-hot"></i></button>
                        </div>
                        <div id="morning-brief-container" class="cafe-card rounded-2xl p-6 hidden animate-fade-in mb-4 shadow-sm relative"><button onclick="document.getElementById('morning-brief-container').classList.add('hidden')" class="absolute top-2 right-2 text-amber-700/50 hover:text-amber-800"><i class="fa-solid fa-times"></i></button><h4 class="font-serif font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-mug-hot"></i> Buenos d√≠as, Patricio</h4><div id="morning-brief-content" class="text-sm leading-relaxed whitespace-pre-wrap font-medium"></div></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Alerta de Casos sin Movimiento -->
                            <div id="danger-zone" class="hidden bg-red-50 rounded-[2rem] p-6 border border-red-100 shadow-sm"><div class="flex items-center gap-3 mb-4"><div class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i></div><div><h3 class="font-serif font-bold text-lg text-red-900">Zona de Peligro</h3><p class="text-xs text-red-700/80 font-medium">Caducidad inminente</p></div></div><div id="danger-list" class="space-y-2"></div></div>
                            <!-- Agenda Pr√≥xima -->
                            <div class="bg-white rounded-[2rem] shadow-card p-8 border border-slate-100 min-h-[300px] flex flex-col"><h3 class="font-serif font-bold text-xl text-slate-800 mb-6 flex items-center gap-3"><i class="fa-regular fa-clock text-brand"></i>Agenda Pr√≥xima</h3><div id="dash-agenda-list" class="space-y-3 flex-1"></div></div>
                        </div>
                        <!-- Flash Tareas -->
                        <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2rem] shadow-2xl p-8 flex flex-col text-white relative overflow-hidden"><h3 class="font-serif font-bold text-xl mb-6 relative z-10"><i class="fa-solid fa-bolt text-amber-400"></i> Flash Tareas</h3><div class="flex gap-2 mb-6 relative z-10"><input id="quick-task-input" class="flex-1 p-3 bg-white/10 border border-white/10 rounded-xl text-xs text-white placeholder:text-slate-400" placeholder="Tarea r√°pida..."><button onclick="window.App.Forms.addTaskQuick()" class="bg-amber-400 text-slate-900 w-10 h-10 rounded-xl font-bold hover:bg-amber-300">+</button></div><div id="dash-tareas-list" class="space-y-3 flex-1 overflow-y-auto pr-1 relative z-10 custom-scrollbar"></div></div>
                    </div>
                </div>

                <!-- PESTA√ëA: CASOS -->
                <div id="tab-casos" class="tab-content hidden h-[calc(100vh-140px)] flex flex-col animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-3xl shadow-card border border-slate-100">
                        <div><h2 class="text-2xl font-serif font-bold text-slate-800">Expedientes</h2><div class="flex gap-3 items-center mt-1"><p class="text-slate-400 text-xs font-medium" id="casos-count">...</p><div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200"><button onclick="window.App.UI.toggleCasosSort('AZ')" id="btn-sort-casos-az" class="px-2 py-1 rounded-md text-[10px] font-bold text-slate-500">A-Z</button><button onclick="window.App.UI.toggleCasosSort('Recent')" id="btn-sort-casos-recent" class="px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800"><i class="fa-solid fa-clock-rotate-left"></i></button></div></div></div>
                        <div class="flex gap-3 w-full md:w-auto items-center">
                            <div class="flex items-center bg-slate-50 rounded-xl px-4 py-3 flex-1 md:w-64 border border-slate-200"><i class="fa-solid fa-magnifying-glass text-slate-400 text-xs mr-3"></i><input id="buscar-caso" onkeyup="window.App.Render.casos()" class="bg-transparent border-none text-xs w-full focus:ring-0 placeholder:text-slate-400 font-medium" placeholder="Buscar..."></div>
                            <button onclick="window.App.Forms.openCaso(false)" class="btn-primary px-6 py-3 rounded-xl text-xs font-bold flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-plus"></i> Nuevo</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden bg-white rounded-3xl shadow-card border border-slate-100 flex flex-col">
                        <div class="grid grid-cols-12 gap-4 p-4 border-b border-slate-100 bg-slate-50 text-[10px] font-bold text-slate-400 uppercase tracking-widest"><div class="col-span-8 md:col-span-6 pl-4">Expediente</div><div class="col-span-4 hidden md:block">Movimiento</div><div class="col-span-4 md:col-span-2 text-right pr-4">Acci√≥n</div></div>
                        <div id="lista-casos-body" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>

                <!-- PESTA√ëA: AGENDA -->
                <div id="tab-agenda" class="tab-content hidden h-[calc(100vh-140px)] flex flex-col animate-fade-in">
                    <div class="flex justify-between items-center mb-6 gap-4 bg-white p-4 rounded-3xl shadow-card border border-slate-100">
                        <div><h2 class="text-2xl font-serif font-bold text-slate-800">Agenda</h2><p class="text-xs text-slate-400 mt-1">Eventos</p></div>
                        <div class="flex gap-3"><button onclick="window.App.UI.toggleAgendaHistory()" id="btn-agenda-history" class="text-xs font-bold text-slate-500 px-4 py-2 rounded-xl border border-slate-200 bg-white">Historial</button><button onclick="window.App.Forms.openAgenda(false)" class="btn-primary px-5 py-3 rounded-xl text-xs font-bold gap-2"><i class="fa-solid fa-plus"></i> Agendar</button></div>
                    </div>
                    <div class="flex gap-3 overflow-x-auto pb-4 px-1"><button onclick="window.App.UI.filterAgenda('Todos')" class="px-5 py-2 rounded-full text-xs font-bold bg-slate-800 text-white">Todo</button><button onclick="window.App.UI.filterAgenda('Audiencia')" class="px-5 py-2 rounded-full text-xs font-bold bg-white text-slate-500 border border-slate-200">Audiencias</button><button onclick="window.App.UI.filterAgenda('Vencimiento')" class="px-5 py-2 rounded-full text-xs font-bold bg-white text-slate-500 border border-slate-200">Vencimientos</button></div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar pr-2" id="lista-agenda-grouped"></div>
                </div>

                <!-- PESTA√ëA: TAREAS -->
                <div id="tab-tareas" class="tab-content hidden space-y-6 animate-fade-in pb-20">
                    <div class="flex justify-between items-center bg-white p-8 rounded-3xl shadow-card border border-slate-100">
                        <div><h2 class="text-3xl font-serif font-bold text-slate-800">Tareas</h2></div>
                        <button onclick="window.App.Forms.openTarea(false)" class="btn-brand px-6 py-3 rounded-xl text-xs font-bold gap-2"><i class="fa-solid fa-plus"></i> Nueva</button>
                    </div>
                    <div id="lista-tareas" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>

                <!-- PESTA√ëA: CONTACTOS -->
                <div id="tab-contactos" class="tab-content hidden space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-8 rounded-3xl shadow-card border border-slate-100 gap-4">
                        <div><h2 class="text-3xl font-serif font-bold text-slate-800">Directorio</h2><div class="flex gap-2 items-center mt-3"><div class="flex bg-slate-100 p-1.5 rounded-xl w-max border border-slate-200"><button onclick="window.App.UI.toggleContactosView('personas')" id="btn-view-personas" class="px-5 py-1.5 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm border border-slate-100">Personas</button><button onclick="window.App.UI.toggleContactosView('organismos')" id="btn-view-organismos" class="px-5 py-1.5 rounded-lg text-xs font-bold text-slate-500">Organismos</button></div><div class="flex bg-slate-100 p-1.5 rounded-xl border border-slate-200"><button onclick="window.App.UI.toggleContactosSort('AZ')" id="btn-sort-az" class="px-3 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800">A-Z</button><button onclick="window.App.UI.toggleContactosSort('Recent')" id="btn-sort-recent" class="px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500"><i class="fa-solid fa-clock-rotate-left"></i></button></div></div></div>
                        <div class="flex gap-3 w-full md:w-auto items-center"><input id="buscar-contacto" onkeyup="window.App.Render.contactos(); window.App.Render.organismos()" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs w-full md:w-64 focus:ring-brand" placeholder="Buscar..."><button onclick="window.App.Forms.newContactoBtn()" class="btn-primary px-6 py-3 rounded-xl text-xs font-bold">Nuevo</button></div>
                    </div>
                    <div id="view-contactos-personas" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    <div id="view-contactos-organismos" class="hidden grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </div>

                <!-- PESTA√ëA: RECURSOS -->
                <div id="tab-links" class="tab-content hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center bg-white p-8 rounded-3xl shadow-card border border-slate-100">
                        <h2 class="text-3xl font-serif font-bold text-slate-800">Recursos</h2>
                        <div class="flex bg-slate-100 rounded-xl p-1 gap-1 border border-slate-200"><button onclick="window.App.UI.toggleRecursos('utiles')" class="px-5 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800">Escritos</button><button onclick="window.App.UI.toggleRecursos('links')" class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500">Enlaces</button></div>
                    </div>
                    <div id="view-utiles"><div class="flex flex-wrap gap-3 mb-6 items-center"><input id="buscar-util" onkeyup="window.App.Render.utiles()" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-sm min-w-[200px]" placeholder="Buscar modelo..."><select id="filter-utiles-tipo" onchange="window.App.Render.utiles()" class="p-3 bg-white border border-slate-200 rounded-xl text-xs font-bold"><option value="Todos">Todos</option><option value="Escrito">Escritos</option><option value="C√©dula">C√©dulas</option><option value="Oficio">Oficios</option><option value="TLC">TLC</option><option value="CD">CD</option></select><button onclick="window.App.Forms.openUtil()" class="btn-brand px-6 py-3 rounded-xl text-xs font-bold">Nuevo</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="lista-utiles"></div></div>
                    <div id="view-links" class="hidden"><div class="flex flex-wrap justify-between mb-6 gap-3 items-center"><input id="buscar-link" onkeyup="window.App.Render.links()" class="p-3 bg-white border border-slate-200 rounded-xl text-sm w-full max-w-md" placeholder="Buscar enlace..."><div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200"><button onclick="window.App.UI.toggleLinksSort('AZ')" id="btn-sort-links-az" class="px-2 py-1 rounded-md text-[10px] font-bold text-slate-500">A-Z</button><button onclick="window.App.UI.toggleLinksSort('Recent')" id="btn-sort-links-recent" class="px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800"><i class="fa-solid fa-clock-rotate-left"></i></button></div><button onclick="window.App.Forms.openLink(false)" class="ml-auto bg-slate-800 text-white px-6 py-3 rounded-xl text-xs font-bold shadow-lg">Agregar</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="lista-links"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES Y POPUPS -->
    <!-- Modal Agenda -->
    <div id="modal-agenda" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl border border-white/50"><h3 class="font-serif font-bold text-2xl mb-6 text-slate-800">Evento</h3><input id="ag-cliente" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-3 text-sm font-bold focus:bg-white focus:ring-2 focus:ring-brand" placeholder="Cliente / T√≠tulo"><div class="flex gap-3 mb-3"><select id="ag-tipo" onchange="window.App.Forms.toggleAgendaModalidad()" class="w-1/2 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium"><option value="Audiencia">Audiencia</option><option value="Vencimiento">Vencimiento</option><option value="Reuni√≥n">Reuni√≥n</option><option value="Otro">Otro</option></select><input type="datetime-local" id="ag-fecha" class="w-1/2 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium"></div><div id="ag-modalidad-container" class="hidden mb-4"><div class="flex gap-3 mb-3"><div onclick="window.App.Forms.selectModalidad('Presencial')" id="mod-card-Presencial" class="flex-1 p-3 rounded-xl border border-slate-200 cursor-pointer text-center hover:bg-slate-50"><i class="fa-solid fa-building text-lg mb-1 block text-slate-400"></i><span class="text-xs font-bold text-slate-600">Presencial</span></div><div onclick="window.App.Forms.selectModalidad('Virtual')" id="mod-card-Virtual" class="flex-1 p-3 rounded-xl border border-slate-200 cursor-pointer text-center hover:bg-slate-50"><i class="fa-solid fa-video text-lg mb-1 block text-slate-400"></i><span class="text-xs font-bold text-slate-600">Virtual</span></div><input type="hidden" id="ag-mod-value" value="Presencial"></div><div id="input-presencial" class="flex gap-2 animate-fade-in"><input id="ag-ubicacion-fisica" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-xs" placeholder="Direcci√≥n"><button onclick="window.App.Utils.searchInMaps('ag-ubicacion-fisica')" class="w-10 h-10 flex items-center justify-center bg-white text-brand rounded-xl border border-slate-200"><i class="fa-solid fa-map-location-dot"></i></button></div><div id="input-virtual" class="hidden animate-fade-in"><div class="flex gap-2"><input id="ag-ubicacion-virtual" class="w-full p-3 bg-white border border-slate-200 rounded-xl text-xs" placeholder="Link Reuni√≥n (Zoom/Meet)"><button onclick="window.App.Utils.openVirtualLinkFromInput('ag-ubicacion-virtual')" class="w-12 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-200 shadow-sm"><i class="fa-solid fa-video"></i></button></div></div></div><input id="ag-causa" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" placeholder="Causa (Opcional)"><textarea id="ag-notas" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm h-24 resize-none" placeholder="Notas..."></textarea><div class="flex justify-between mt-6"><button id="btn-borrar-agenda" onclick="window.App.Forms.deleteAgenda()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-4 py-2 rounded-xl">Eliminar</button><div class="flex gap-3 ml-auto items-center"><button onclick="window.App.Utils.addToGoogleCalendar()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 hover:text-brand flex items-center justify-center shadow-sm" title="Agregar a Google Calendar"><i class="fa-brands fa-google"></i></button><button onclick="window.App.UI.closeModal('modal-agenda')" class="text-slate-500 text-xs px-5 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveAgenda()" class="btn-primary px-6 py-3 rounded-xl text-xs font-bold shadow-lg">Agendar</button></div></div></div></div>
    
    <!-- Modal Caso -->
    <div id="modal-caso" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container">
        <div class="bg-white rounded-[2rem] w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col h-[85vh] animate-fade-in border border-white/50">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/80"><h3 class="font-serif font-bold text-xl text-slate-800" id="caso-modal-title">Expediente</h3><button onclick="window.App.UI.closeModal('modal-caso')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="px-6 py-2 bg-white border-b border-slate-100 flex gap-2 overflow-x-auto"><button onclick="window.App.UI.switchCasoTab('datos')" id="tab-caso-datos" class="tab-btn-internal active whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold">Datos</button><button onclick="window.App.UI.switchCasoTab('novedades')" id="tab-caso-novedades" class="tab-btn-internal whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold">Seguimiento</button><button onclick="window.App.UI.switchCasoTab('conta')" id="tab-caso-conta" class="tab-btn-internal whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold">Contabilidad</button></div>
            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-white relative">
                <div id="content-caso-datos">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <datalist id="list-contrapartes"></datalist><datalist id="list-abogados"></datalist>
                        <div class="col-span-full"><label class="label-sm">Car√°tula</label><input id="ca-caratula" onkeyup="window.App.Utils.checkConflicts('ca-caratula', 'conflict-caratula')" class="input-std font-bold text-slate-700" placeholder="Ej: Perez c/ Gonzalez"><div id="conflict-caratula" class="conflict-alert"></div></div>
                        <div class="col-span-full"><label class="label-sm"><i class="fa-brands fa-google-drive"></i> Carpeta Digital</label><div class="flex gap-2"><input id="ca-drive-link" class="input-std flex-1" placeholder="https://drive.google.com/..."><button onclick="window.App.Utils.openDriveLinkFromInput('ca-drive-link')" class="w-12 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-200 shadow-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i></button></div></div>
                        <div><label class="label-sm">Cliente</label><input id="ca-cliente" onkeyup="window.App.Utils.checkConflicts('ca-cliente', 'conflict-cliente')" class="input-std" placeholder="Nombre"><div id="conflict-cliente" class="conflict-alert"></div></div>
                        <div><label class="label-sm">Tel√©fono</label><div class="flex gap-2"><input id="ca-cliente-tel" class="input-std flex-1" placeholder="+54 9 ..."><button onclick="window.App.Utils.whatsappCliente()" class="w-12 bg-green-500 text-white rounded-xl hover:bg-green-600 shadow-md"><i class="fa-brands fa-whatsapp"></i></button></div></div>
                        <div><label class="label-sm">Expediente N¬∞</label><input id="ca-expediente" class="input-std"></div><div><label class="label-sm">Juzgado</label><input id="ca-juzgado" class="input-std"></div>
                        <div class="col-span-full"><label class="label-sm">Estado</label><select id="ca-paso" class="input-std"><option value="Inicio">Inicio / Mediaci√≥n</option><option value="Demanda">Demanda</option><option value="Contestaci√≥n">Contestaci√≥n</option><option value="Prueba">Prueba</option><option value="Sentencia">Sentencia</option><option value="Ejecuci√≥n">Ejecuci√≥n</option><option value="Archivado">Archivado</option></select></div>
                        <div class="col-span-full border-t border-slate-100 pt-4"><h4 class="text-xs font-bold text-slate-800">Contraparte</h4></div>
                        <div class="col-span-full"><input id="ca-contraparte" list="list-contrapartes" onkeyup="window.App.Utils.checkConflicts('ca-contraparte', 'conflict-contra')" class="input-std" placeholder="Nombre Contraparte"><div id="conflict-contra" class="conflict-alert"></div></div>
                        <div><input id="ca-abogado-contra" list="list-abogados" class="input-std" placeholder="Abogado Contraparte"></div><div class="flex gap-2"><input id="ca-abogado-email" class="w-1/2 input-std" placeholder="Email Letrado"><input id="ca-abogado-tel" class="w-1/2 input-std" placeholder="Celular Letrado"></div>
                        <div class="col-span-full border-t border-slate-100 pt-4"><h4 class="text-xs font-bold text-slate-800">Auxiliar</h4></div>
                        <div class="col-span-full"><input id="ca-auxiliar-nombre" class="input-std" placeholder="Nombre (Perito, S√≠ndico)"></div><div class="flex gap-2 col-span-full"><input id="ca-auxiliar-tel" class="w-1/2 input-std" placeholder="Tel√©fono"><input id="ca-auxiliar-email" class="w-1/2 input-std" placeholder="Email"></div>
                        <div class="col-span-full border-t border-slate-100 pt-4"><label class="label-sm">Encabezado Autom√°tico (Para Escritos)</label><textarea id="ca-encabezado" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs resize-none h-20 focus:bg-white focus:ring-2 focus:ring-brand outline-none transition" placeholder="Ej: SE PRESENTA..."></textarea></div>
                    </div>
                </div>
                <div id="content-caso-novedades" class="hidden">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6 shadow-sm"><h4 class="font-bold text-slate-800 text-sm mb-3">Nuevo Paso Manual</h4><div class="flex gap-2 mb-2"><input id="man-mov-fecha" type="date" class="w-1/3 p-2 rounded-lg text-xs border border-slate-200"><input id="man-mov-tipo" class="w-2/3 p-2 rounded-lg text-xs border border-slate-200" placeholder="Tipo (ej: C√©dula)"></div><textarea id="man-mov-desc" class="w-full p-2 rounded-lg text-xs border border-slate-200 mb-2 h-16 resize-none" placeholder="Descripci√≥n..."></textarea><button onclick="window.App.Forms.saveManualMov()" id="btn-save-manual-mov" class="bg-slate-800 text-white w-full py-2 rounded-lg text-xs font-bold hover:bg-slate-700">Agregar</button><button onclick="window.App.Forms.cancelManualMov()" id="btn-cancel-manual-mov" class="hidden text-red-500 w-full py-2 text-xs font-bold hover:bg-red-50 rounded-lg mt-1">Cancelar</button></div>
                    <div id="lista-movimientos" class="space-y-3"></div>
                </div>
                <div id="content-caso-conta" class="hidden"><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100"><p class="text-[10px] uppercase font-bold text-emerald-600">Ingresos</p><p class="text-xl font-bold text-emerald-700" id="conta-ingresos">$0</p></div><div class="bg-red-50 p-4 rounded-2xl border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Gastos</p><p class="text-xl font-bold text-red-700" id="conta-egresos">$0</p></div><div class="bg-slate-50 p-4 rounded-2xl border border-slate-100"><p class="text-[10px] uppercase font-bold text-slate-500">Balance</p><p class="text-xl font-bold text-slate-800" id="conta-balance">$0</p></div></div><div class="flex gap-2 mb-4 bg-slate-100 p-2 rounded-xl" id="conta-form-container"><select id="new-mov-tipo" class="p-2 rounded-lg text-xs font-bold border-0"><option value="Egreso">Gasto</option><option value="Ingreso">Cobro</option></select><input id="new-mov-desc" class="flex-1 p-2 rounded-lg text-xs border-0" placeholder="Concepto"><input id="new-mov-monto" type="number" class="w-24 p-2 rounded-lg text-xs border-0" placeholder="$"><button onclick="window.App.Forms.addContaMov()" id="btn-save-conta" class="bg-slate-800 text-white px-3 rounded-lg text-xs font-bold hover:bg-slate-700 transition w-20">+</button></div><div id="lista-contable" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div></div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50/50 flex justify-between"><button id="btn-borrar-caso" onclick="window.App.Forms.deleteCaso()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-4 py-3 rounded-xl flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> Eliminar</button><div class="flex gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-caso')" class="text-xs text-slate-500 px-4 hover:bg-slate-200 rounded-xl font-bold py-3">Cancelar</button><button onclick="window.App.Forms.saveCaso()" class="bg-slate-900 text-white px-8 py-3 rounded-xl text-xs font-bold hover:bg-slate-800 shadow-lg">Guardar</button></div></div>
        </div>
    </div>

    <!-- Otros Modales (Tarea, Contacto, etc.) -->
    <div id="modal-tarea-full" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl border border-white/50"><h3 class="font-serif font-bold text-2xl mb-6 text-slate-800">Tarea</h3><input id="ta-texto" class="w-full p-4 bg-slate-50 border-0 rounded-2xl mb-3 text-sm font-bold placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-brand" placeholder="¬øQu√© hay que hacer?"><div class="flex gap-3 mb-3"><select id="ta-prioridad" class="w-1/2 p-3 bg-slate-50 border-0 rounded-xl text-sm font-medium"><option value="Normal">Normal</option><option value="Alta">Alta üî•</option><option value="Baja">Baja ‚òï</option></select><input type="date" id="ta-vencimiento" class="w-1/2 p-3 bg-slate-50 border-0 rounded-xl text-sm text-slate-600"></div><textarea id="ta-descripcion" class="w-full p-4 bg-slate-50 border-0 rounded-xl text-sm h-28 mb-6 resize-none" placeholder="Detalles..."></textarea><div class="flex justify-between"><button id="btn-borrar-tarea" onclick="window.App.Forms.deleteTarea()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-4 py-2 rounded-xl">Eliminar</button><div class="flex gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-tarea-full')" class="text-slate-500 text-xs px-5 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveTarea()" class="btn-brand px-6 py-3 rounded-xl text-xs font-bold shadow-glow">Guardar</button></div></div></div></div>
    
    <div id="modal-contacto" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-8 rounded-[2rem] w-full max-w-sm shadow-2xl border border-white/50"><div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-4 text-xl"><i class="fa-regular fa-user"></i></div><h3 class="font-serif font-bold text-xl mb-6 text-slate-800">Contacto</h3><div class="space-y-3"><input id="co-nombre" onkeyup="window.App.Utils.checkConflicts('co-nombre', 'conflict-co')" class="input-std" placeholder="Nombre completo"><div id="conflict-co" class="conflict-alert hidden text-xs text-amber-600 bg-amber-50 p-2 rounded"></div><div><input id="co-telefono" class="input-std" placeholder="Tel√©fono" value="+54 9 "><p class="text-[10px] text-slate-400 mt-1 ml-1">Auto-formato WhatsApp</p></div><input id="co-email" class="input-std" placeholder="Email"><select id="co-rol" class="input-std"><option value="Cliente">Cliente</option><option value="Colega">Colega</option><option value="Auxiliar">Auxiliar</option></select></div><div class="flex justify-between mt-6"><button id="btn-borrar-contacto" onclick="window.App.Forms.deleteContacto()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-3 py-2 rounded-xl">Eliminar</button><div class="flex justify-end gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-contacto')" class="text-xs text-slate-500 px-4 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveContacto()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-indigo-700 shadow-lg">Guardar</button></div></div></div></div>
    
    <div id="modal-organismo" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl border border-white/50"><div class="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mb-4 text-xl"><i class="fa-solid fa-building-columns"></i></div><h3 class="font-serif font-bold text-xl mb-6 text-slate-800">Organismo / Juzgado</h3><input id="org-nombre" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm font-bold" placeholder="Nombre (Ej: Juzgado Civil 1)"><div class="flex gap-3 mb-3"><select id="org-tipo" class="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm"><option value="Juzgado">Juzgado</option><option value="Oficina">Oficina</option><option value="Registro">Registro</option><option value="Otro">Otro</option></select><input id="org-tel" class="w-2/3 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="Tel√©fono" value="+54 9 "></div><input id="org-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" placeholder="Email"><div class="flex gap-2 mb-3"><input id="org-direccion" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="Direcci√≥n Real"><button onclick="window.App.Utils.searchInMaps('org-direccion')" class="w-12 bg-slate-100 text-slate-500 rounded-xl flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-map-location-dot"></i></button></div><div class="flex justify-between mt-6"><button id="btn-borrar-org" onclick="window.App.Forms.deleteOrg()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-3 py-2 rounded-xl">Eliminar</button><div class="flex gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-organismo')" class="text-xs text-slate-500 px-4 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveOrg()" class="bg-slate-900 text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-800 shadow-lg">Guardar</button></div></div></div></div>
    
    <div id="modal-util" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-6 rounded-[2rem] w-full max-w-6xl h-[90vh] flex flex-col shadow-2xl border border-white/50"><div class="flex justify-between items-center mb-4"><h3 class="font-serif font-bold text-xl text-slate-800">Modelo</h3><select id="ut-tipo" class="p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold"><option value="Escrito">Escrito</option><option value="C√©dula">C√©dula</option><option value="Oficio">Oficio</option><option value="TLC">TLC</option><option value="CD">Carta Documento</option></select></div><div class="flex gap-2 mb-3 items-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Insertar:</span><button onclick="window.App.Forms.insertVar('{{caratula}}')" class="bg-indigo-50 px-2 py-1 rounded text-[10px] font-bold text-indigo-700 hover:bg-indigo-100">Car√°tula</button><button onclick="window.App.Forms.insertVar('{{cliente}}')" class="bg-indigo-50 px-2 py-1 rounded text-[10px] font-bold text-indigo-700 hover:bg-indigo-100">Cliente</button><button onclick="window.App.Forms.insertVar('{{expediente}}')" class="bg-indigo-50 px-2 py-1 rounded text-[10px] font-bold text-indigo-700 hover:bg-indigo-100">Expte N¬∞</button><button onclick="window.App.Forms.insertVar('{{juzgado}}')" class="bg-indigo-50 px-2 py-1 rounded text-[10px] font-bold text-indigo-700 hover:bg-indigo-100">Juzgado</button></div><input id="ut-titulo" class="w-full mb-3 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg placeholder:text-slate-400" placeholder="T√≠tulo"><textarea id="ut-contenido" class="flex-1 p-6 bg-slate-50 border border-slate-200 rounded-xl font-mono text-base resize-none mb-4 leading-relaxed focus:bg-white focus:ring-2 focus:ring-slate-200 transition" placeholder="Redacta aqu√≠..."></textarea><div class="bg-indigo-50 p-3 rounded-xl flex gap-3 items-center mb-4"><p class="text-xs font-bold text-indigo-800">Generar para:</p><select id="ut-select-caso" class="flex-1 p-2 rounded-lg text-xs border-indigo-200 text-slate-600"><option value="">-- Seleccionar Expediente --</option></select><button onclick="window.App.Utils.printModel()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-md"><i class="fa-solid fa-print"></i> PDF</button></div><div class="flex justify-between"><button id="btn-borrar-util" onclick="window.App.Forms.deleteUtil()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-4 py-2 rounded-xl">Eliminar</button><div class="flex gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-util')" class="text-xs text-slate-500 px-4 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveUtil()" class="bg-brand text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-brand-dark shadow-glow">Guardar</button></div></div></div></div>
    
    <div id="modal-link" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container"><div class="bg-white p-8 rounded-[2rem] max-w-sm w-full shadow-2xl border border-white/50"><div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-4 text-xl"><i class="fa-solid fa-link"></i></div><h3 class="font-serif font-bold text-xl mb-4 text-slate-800">Nuevo Enlace</h3><input id="li-nombre" class="w-full mb-3 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="Nombre"><input id="li-url" class="w-full mb-6 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="URL (https://...)"><div class="flex justify-between"><button id="btn-borrar-link" onclick="window.App.Forms.deleteLink()" class="text-red-500 text-xs font-bold hidden hover:bg-red-50 px-4 py-2 rounded-xl">Eliminar</button><div class="flex justify-end gap-3 ml-auto"><button onclick="window.App.UI.closeModal('modal-link')" class="text-xs text-slate-500 px-4 hover:bg-slate-50 rounded-xl font-bold py-2">Cancelar</button><button onclick="window.App.Forms.saveLink()" class="bg-slate-800 text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 shadow-lg">Guardar</button></div></div></div></div>
    
    <div id="modal-confirm" class="hidden fixed inset-0 bg-slate-900/60 z-[100] flex items-center justify-center p-4 modal-container backdrop-blur-sm"><div class="bg-white p-8 rounded-[2rem] max-w-xs text-center shadow-2xl border border-white/50"><div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-triangle-exclamation"></i></div><h3 id="confirm-title" class="font-bold text-xl mb-2 text-slate-800">Confirmar</h3><p id="confirm-msg" class="text-sm text-slate-500 mb-6">¬øSeguro?</p><div class="flex gap-3 justify-center"><button onclick="window.App.UI.closeModal('modal-confirm')" class="px-5 py-2.5 rounded-xl bg-slate-100 text-slate-600 text-xs font-bold hover:bg-slate-200">Cancelar</button><button id="btn-confirm-action" class="px-5 py-2.5 rounded-xl bg-slate-900 text-white text-xs font-bold hover:bg-slate-800 shadow-lg">Confirmar</button></div></div></div>
    
    <div id="modal-almanaque" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-xl modal-container"><div class="bg-white rounded-[2.5rem] w-full max-w-[95%] h-[90vh] flex flex-col md:flex-row shadow-2xl overflow-hidden border border-white/60"><div class="flex-[2] p-8 flex flex-col border-r border-slate-100 bg-white relative"><div class="flex justify-between items-center mb-8"><div><h3 class="font-serif font-bold text-3xl text-slate-800 tracking-tight" id="alm-title">Mes</h3><p class="text-xs text-slate-400 mt-1 font-medium tracking-wide uppercase">Calendario Judicial</p></div><div class="flex gap-2 bg-slate-50 p-1 rounded-2xl border border-slate-100"><button onclick="window.App.Utils.changeMonth(-1)" class="w-10 h-10 rounded-xl hover:bg-white flex items-center justify-center text-slate-400 hover:text-slate-600"><i class="fa-solid fa-chevron-left"></i></button><div class="w-px h-6 bg-slate-200 self-center"></div><button onclick="window.App.Utils.changeMonth(1)" class="w-10 h-10 rounded-xl hover:bg-white flex items-center justify-center text-slate-400 hover:text-slate-600"><i class="fa-solid fa-chevron-right"></i></button></div></div><div class="grid grid-cols-7 gap-4 text-center mb-4"><div class="text-[11px] font-bold text-red-400 uppercase tracking-widest">Dom</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Lun</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Mar</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Mi√©</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Jue</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Vie</div><div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">S√°b</div></div><div id="alm-grid" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto custom-scrollbar p-1"></div></div><div class="flex-1 bg-slate-50/50 p-8 flex flex-col relative w-full md:max-w-md h-full overflow-hidden"><div class="flex justify-between items-start mb-8 shrink-0"><div><h3 class="font-bold text-xl text-slate-800">Calculadora</h3><p class="text-xs text-slate-400">Plazos Procesales</p></div><button onclick="window.App.UI.closeModal('modal-almanaque')" class="w-9 h-9 flex items-center justify-center rounded-full bg-white hover:bg-slate-100 text-slate-400 border border-slate-100"><i class="fa-solid fa-xmark"></i></button></div><div class="flex-1 flex flex-col overflow-y-auto custom-scrollbar pr-2"><div class="space-y-6 mb-auto"><div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Fecha Notificaci√≥n</label><input type="date" id="calc-inicio" class="w-full p-3 bg-slate-50 border-0 rounded-xl text-sm font-medium focus:ring-2 focus:ring-brand/20 text-slate-600"></div><div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">D√≠as H√°biles</label><input type="number" id="calc-dias" class="w-full p-3 bg-slate-50 border-0 rounded-xl text-sm font-medium focus:ring-2 focus:ring-brand/20" placeholder="Ej: 5, 10, 15"></div><button onclick="window.App.Utils.calculateDeadline()" class="w-full bg-slate-900 text-white py-4 rounded-xl text-sm font-bold hover:bg-slate-800 shadow-lg shadow-slate-900/20 transition transform hover:scale-[1.02]">Calcular</button><div id="calc-resultado" class="hidden mt-2 p-6 bg-white rounded-2xl border border-slate-100 shadow-card text-center animate-fade-in relative overflow-hidden"><div class="absolute top-0 left-0 w-1 h-full bg-brand"></div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Vence el</p><p class="text-3xl font-serif font-bold text-slate-800" id="res-fecha">-</p><div class="mt-4 pt-4 border-t border-slate-50"><p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Con Gracia</p><p class="text-lg font-bold text-brand" id="res-gracia">4 primeras horas sgte.</p></div></div></div></div></div></div></div>

    <div id="modal-day-view" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-md modal-container">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm shadow-2xl border border-white/50">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-serif font-bold text-2xl text-slate-800" id="day-view-title">-</h3>
                <button onclick="window.App.UI.closeModal('modal-day-view')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="day-view-content" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar mb-4"></div>
            <div class="pt-4 border-t border-slate-100 text-center">
                <button id="btn-toggle-holiday" class="text-xs font-bold text-slate-400 hover:text-brand transition uppercase tracking-wider">Marcar/Desmarcar Feriado</button>
            </div>
        </div>
    </div>

    <!-- LOGICA DEL SISTEMA (JAVASCRIPT) -->
    <script>
        // CONFIGURACI√ìN GENERAL
        const CONFIG = {
            firebase: { apiKey: "AIzaSyARPztZv7T0xjEWtBm6cfpTIVz6H6rbyOY", authDomain: "agenda-pvm.firebaseapp.com", projectId: "agenda-pvm", storageBucket: "agenda-pvm.firebasestorage.app", messagingSenderId: "1000500981541", appId: "1:1000500981541:web:0c3427d072b9a9979734cc" },
            feriadosBase: ["2025-01-01","2025-03-03","2025-03-04","2025-03-24","2025-04-02","2025-04-18","2025-05-01","2025-05-25","2025-06-16","2025-06-20","2025-07-09","2025-10-13","2025-11-24","2025-12-08","2025-12-25"]
        };
        const STORAGE_KEY_API = 'gemini_api_key'; 
        
        // MANIFEST PARA PWA
        const pwaManifest = { "name": "Estudio Jur√≠dico Van Meegroot", "short_name": "Estudio VM", "start_url": ".", "display": "standalone", "background_color": "#f3f4f6", "theme_color": "#f3f4f6", "icons": [ { "src": "https://cdn-icons-png.flaticon.com/512/924/924915.png", "sizes": "192x192", "type": "image/png" }, { "src": "https://cdn-icons-png.flaticon.com/512/924/924915.png", "sizes": "512x512", "type": "image/png" } ] };
        document.querySelector('#my-manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(pwaManifest)], {type: 'application/json'})));

        // CLASE PRINCIPAL
        class LegalApp {
            constructor() {
                this.state = { user: null, agenda: [], casos: [], links: [], utiles: [], feriados: [], movimientos: [], tareas: [], contactos: [], organismos: [] };
                this.uiState = { filterAg: 'Todos', viewCt: 'personas', sortCt: 'AZ', sortCasos: 'Recent', sortLinks: 'Recent', curCase: null, historiaAgenda: false, curMonth: new Date().getMonth(), curYear: new Date().getFullYear() };
                this.editState = { agenda: null, caso: null, util: null, link: null, tarea: null, contacto: null, org: null, mov: null, movMan: null };
                this.listeners = [];
                this.initFirebase();
                this.Auth = new AuthModule(this);
                this.Data = new DataModule(this);
                this.UI = new UIModule(this);
                this.Render = new RenderModule(this);
                this.Forms = new FormsModule(this);
                this.IA = new IAModule(this);
                this.Utils = new UtilsModule(this);
            }
            initFirebase() {
                firebase.initializeApp(CONFIG.firebase);
                this.auth = firebase.auth();
                this.db = firebase.firestore();
                this.auth.onAuthStateChanged(u => {
                    this.state.user = u;
                    this.UI.toggleView('login-screen', !u);
                    this.UI.toggleView('app-screen', !!u);
                    if (u) { document.getElementById('user-email-display').innerText = u.isAnonymous ? 'Invitado' : u.email; this.Data.listen(); }
                });
            }
        }

        // M√ìDULO AUTENTICACI√ìN
        class AuthModule {
            constructor(app) { this.app = app; }
            async login() {
                this.app.UI.toggleLoader('loader-ingresar', true);
                try { await this.app.auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-pass').value); }
                catch (e) { this.app.UI.toast(e.message, 'error'); } finally { this.app.UI.toggleLoader('loader-ingresar', false); }
            }
            async register() { try { await this.app.auth.createUserWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-pass').value); this.app.UI.toast("Bienvenido"); } catch (e) { this.app.UI.toast(e.message, 'error'); } }
            async guest() { try { await this.app.auth.signInAnonymously(); } catch (e) { this.app.UI.toast(e.message, 'error'); } }
            async logout() { await this.app.auth.signOut(); location.reload(); }
        }

        // M√ìDULO DATOS
        class DataModule {
            constructor(app) { this.app = app; }
            listen() {
                this.app.listeners.forEach(u => u && u()); this.app.listeners = [];
                document.getElementById('connection-status').innerText = "Conectado";
                ['agenda','movimientos','casos','tareas','contactos','organismos','links','utiles','feriados'].forEach(c => {
                    this.app.listeners.push(this.app.db.collection(c).where('uid', '==', this.app.state.user.uid).onSnapshot(s => {
                        this.app.state[c] = s.docs.map(d => ({ id: d.id, ...d.data() })); this.app.Render.all(c);
                    }));
                });
            }
            async save(col, id, data, msg = 'Guardado') {
                try {
                    if (id) await this.app.db.collection(col).doc(id).update(data);
                    else await this.app.db.collection(col).add({ ...data, uid: this.app.state.user.uid, createdAt: Date.now() });
                    this.app.UI.toast(msg); return true;
                } catch (e) { this.app.UI.toast(e.message, 'error'); return false; }
            }
            delete(col, id) { this.app.UI.confirmAction("¬øEliminar?", "No se puede deshacer.", () => this.app.db.collection(col).doc(id).delete().then(() => this.app.UI.toast("Eliminado"))); }
            touchContact(col, id) { this.app.db.collection(col).doc(id).update({ lastContactedAt: Date.now() }); }
            touchCase(id) { this.app.db.collection('casos').doc(id).update({ updatedAt: Date.now() }); }
            backup() {
                const url = URL.createObjectURL(new Blob([JSON.stringify(this.app.state, null, 2)], { type: 'application/json' }));
                const a = document.createElement('a'); a.href = url; a.download = `backup_van_meegroot_${new Date().toISOString().split('T')[0]}.json`; a.click();
            }
        }

        // M√ìDULO UI
        class UIModule {
            constructor(app) {
                this.app = app;
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-container').forEach(el => !el.classList.contains('hidden') && this.toggleView(el.id, false));
                        this.toggleView('config-popup', false);
                        document.getElementById('search-results').classList.add('hidden');
                    }
                });
            }
            toggleView(id, show) { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !show); }
            toggleLoader(id, show) { this.toggleView(id, show); }
            toast(msg, type = 'success') {
                const el = document.createElement('div');
                el.className = `fixed top-6 right-6 z-[100] bg-white px-4 py-3 rounded-lg shadow-lg border-l-4 ${type === 'error' ? 'border-red-500 text-red-600' : 'border-emerald-500 text-emerald-600'} text-xs font-bold animate-fade-in flex gap-2`;
                el.innerHTML = `<i class="fa-solid ${type === 'error' ? 'fa-triangle-exclamation' : 'fa-check-circle'}"></i> ${msg}`;
                document.body.appendChild(el); setTimeout(() => el.remove(), 3000);
            }
            changeTab(tab) {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
                document.querySelectorAll('.nav-pill').forEach(e => e.classList.remove('active'));
                this.toggleView(`tab-${tab}`, true);
                document.getElementById(`btn-${tab}`).classList.add('active');
                if (tab === 'inicio') this.app.Render.dash(); else this.app.Render.all(tab);
            }
            toggleConfig() { document.getElementById('config-popup').classList.toggle('hidden'); document.getElementById('gemini-key-input').value = localStorage.getItem(STORAGE_KEY_API) || ''; }
            saveConfig() { localStorage.setItem(STORAGE_KEY_API, document.getElementById('gemini-key-input').value); this.toggleConfig(); this.toast("Guardado"); }
            closeModal(id) { this.toggleView(id, false); }
            confirmAction(t, m, action) {
                document.getElementById('confirm-title').innerText = t; document.getElementById('confirm-msg').innerText = m;
                this.toggleView('modal-confirm', true);
                document.getElementById('btn-confirm-action').onclick = () => { action(); this.toggleView('modal-confirm', false); };
            }
            toggleAgendaHistory() { this.app.uiState.historiaAgenda = !this.app.uiState.historiaAgenda; this.app.Render.agenda(); }
            filterAgenda(f) { this.app.uiState.filterAg = f; this.app.Render.agenda(); }
            toggleContactosView(v) { this.app.uiState.viewCt = v; this.app.Render.contactos(); }
            toggleContactosSort(s) { 
                this.app.uiState.sortCt = s; 
                document.getElementById('btn-sort-az').className = s === 'AZ' ? "px-3 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800" : "px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500";
                document.getElementById('btn-sort-recent').className = s === 'Recent' ? "px-3 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800" : "px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500";
                this.app.Render.contactos(); 
            }
            toggleCasosSort(s) {
                this.app.uiState.sortCasos = s;
                document.getElementById('btn-sort-casos-az').className = s === 'AZ' ? "px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800" : "px-2 py-1 rounded-md text-[10px] font-bold text-slate-500";
                document.getElementById('btn-sort-casos-recent').className = s === 'Recent' ? "px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800" : "px-2 py-1 rounded-md text-[10px] font-bold text-slate-500";
                this.app.Render.casos();
            }
            toggleLinksSort(s) {
                this.app.uiState.sortLinks = s;
                document.getElementById('btn-sort-links-az').className = s === 'AZ' ? "px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800" : "px-2 py-1 rounded-md text-[10px] font-bold text-slate-500";
                document.getElementById('btn-sort-links-recent').className = s === 'Recent' ? "px-2 py-1 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800" : "px-2 py-1 rounded-md text-[10px] font-bold text-slate-500";
                this.app.Render.links();
            }
            toggleRecursos(t) { this.toggleView('view-links', t === 'links'); this.toggleView('view-utiles', t === 'utiles'); }
            openCalendar() { this.app.Render.calendar(); this.toggleView('modal-almanaque', true); }
            switchCasoTab(t) { ['datos','novedades','conta'].forEach(x => { this.toggleView(`content-caso-${x}`, x === t); document.getElementById(`tab-caso-${x}`).classList.toggle('active', x === t); }); }
            openDayView(dateStr) { this.app.Render.dayView(dateStr); this.toggleView('modal-day-view', true); }
        }

        // M√ìDULO RENDERIZADO
        class RenderModule {
            constructor(app) { this.app = app; }
            all(c) { if(!c || c==='agenda') this.agenda(); if(!c || c==='casos') this.casos(); if(!c || c==='tareas') this.tareas(); if(!c || ['contactos','organismos'].includes(c)) this.contactos(); if(!c || c==='links') this.links(); if(!c || c==='utiles') this.utiles(); if(!c || c==='feriados') this.calendar(); if(!c || c==='movimientos') { if(this.app.uiState.curCase) this.movs(); this.casos(); } this.dash(); }
            
            dash() {
                const now = Date.now(), limit = 90 * 86400000;
                const idle = this.app.state.casos.filter(c => (now - (c.updatedAt||0)) > limit);
                document.getElementById('danger-zone').classList.toggle('hidden', idle.length === 0);
                document.getElementById('danger-list').innerHTML = idle.slice(0,3).map(c => `<div onclick="window.App.Forms.openCaso('${c.id}')" class="bg-white/80 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white transition border border-red-100"><div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div><div class="overflow-hidden flex-1"><p class="text-xs font-bold text-slate-800 truncate">${c.caratula}</p><p class="text-[10px] text-red-500 font-bold uppercase">${Math.floor((now-(c.updatedAt||0))/86400000)} d√≠as sin mov.</p></div><i class="fa-solid fa-chevron-right text-[10px] text-red-300"></i></div>`).join('');
                
                const next = this.app.state.agenda.filter(a => a.fechaHora && new Date(a.fechaHora) >= new Date()).sort((a,b) => new Date(a.fechaHora) - new Date(b.fechaHora)).slice(0,3);
                document.getElementById('dash-agenda-list').innerHTML = next.length ? next.map(e => {
                    const d = new Date(e.fechaHora);
                    return `<div onclick="window.App.Forms.openAgenda('${e.id}')" class="bg-white p-4 rounded-2xl shadow-sm border-l-[6px] ${e.tipo==='Audiencia'?'border-red-500':'border-brand'} flex justify-between cursor-pointer hover:shadow-md transition"><div class="flex gap-4 items-center"><div class="text-center w-14 shrink-0"><p class="font-serif font-bold text-xl text-slate-800 leading-none">${d.getDate()}</p><p class="text-[9px] font-bold text-slate-400 uppercase leading-none mb-1">${d.toLocaleDateString('es-AR', {month:'short'}).replace('.','')}</p><p class="text-[10px] font-bold text-brand bg-brand-surface px-1 rounded">${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}hs</p></div><div class="w-px bg-slate-100 h-10"></div><div class="overflow-hidden"><h4 class="font-bold text-sm text-slate-800 truncate">${e.cliente}</h4><p class="text-xs text-slate-400 truncate">${e.causa||e.tipo}</p></div></div><button onclick="event.stopPropagation(); window.App.Data.delete('agenda','${e.id}')" class="text-slate-300 hover:text-red-500 self-center"><i class="fa-solid fa-trash"></i></button></div>`;
                }).join('') : '<div class="text-center py-6 text-slate-400 text-xs italic">Nada pr√≥ximo.</div>';
                
                const flash = this.app.state.tareas.filter(t => !t.completada).sort((a,b) => (a.vencimiento?new Date(a.vencimiento):9e15) - (b.vencimiento?new Date(b.vencimiento):9e15)).slice(0,5);
                document.getElementById('dash-tareas-list').innerHTML = flash.length ? flash.map(t => `<div class="flex items-center gap-3 text-xs text-slate-300 border-b border-white/10 pb-3"><div onclick="window.App.Forms.toggleTareaCompletada('${t.id}')" class="cursor-pointer hover:text-white"><i class="fa-regular fa-square text-amber-400"></i></div><span onclick="window.App.Forms.openTarea('${t.id}')" class="truncate cursor-pointer hover:text-white flex-1">${t.texto}</span>${t.vencimiento ? `<span class="text-[10px] font-bold text-slate-400 ml-2 whitespace-nowrap opacity-70">${t.vencimiento.split('-')[2]}/${t.vencimiento.split('-')[1]}</span>` : ''}</div>`).join('') : '<p class="text-slate-400/50 text-xs italic text-center mt-4">Al d√≠a.</p>';
            }

            casos() {
                const q = document.getElementById('buscar-caso').value.toLowerCase();
                const list = this.app.state.casos.filter(c => !q || (c.caratula+c.cliente).toLowerCase().includes(q));
                if (this.app.uiState.sortCasos === 'AZ') list.sort((a,b) => a.caratula.localeCompare(b.caratula)); else list.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
                document.getElementById('casos-count').innerText = `${list.length} expedientes`;
                document.getElementById('lista-casos-body').innerHTML = list.map(c => {
                    const days = Math.floor((Date.now()-(c.updatedAt||0))/86400000), color = days>90?'bg-red-500':(days>30?'bg-yellow-400':'bg-emerald-500');
                    const lastMov = this.app.state.movimientos.filter(m => m.caseId===c.id && m.tag==='novedad').sort((a,b)=>b.date-a.date)[0];
                    return `<div onclick="window.App.Forms.openCaso('${c.id}')" class="flex flex-col md:flex-row md:items-center gap-3 p-4 border-b border-slate-50 cursor-pointer hover:bg-slate-50 transition relative"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-1"><div class="${color} w-2 h-2 rounded-full shrink-0"></div><h4 class="font-bold text-sm text-slate-800 truncate">${c.caratula}</h4><span class="md:hidden px-2 py-0.5 rounded bg-slate-100 text-[9px] font-bold text-slate-500 border border-slate-200 whitespace-nowrap ml-auto">${c.paso}</span></div><div class="pl-4"><p class="text-[10px] text-slate-400 uppercase truncate">${c.cliente}</p></div></div><div class="md:w-1/3 pl-4 md:pl-0 border-l-2 border-slate-100 md:border-0"><p class="text-[9px] font-bold text-slate-300 uppercase md:hidden mb-0.5">√öltimo:</p>${lastMov ? `<div class="text-xs text-slate-600 truncate"><span class="font-bold text-slate-700">${this.app.Utils.fmtDate(lastMov.date)}</span> - ${lastMov.tipo}</div>` : '<span class="text-slate-300 italic text-[10px]">Sin novedades</span>'}</div><div class="flex items-center gap-3 justify-end md:w-auto pl-4 md:pl-0"><span class="hidden md:inline-block px-2 py-1 rounded bg-slate-100 text-[10px] font-bold text-slate-500 border border-slate-200 whitespace-nowrap">${c.paso}</span>${c.driveLink?`<a href="${c.driveLink.startsWith('http')?c.driveLink:'https://'+c.driveLink}" target="_blank" onclick="event.stopPropagation()" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fa-brands fa-google-drive"></i></a>`:''}</div></div>`;
                }).join('');
            }

            agenda() {
                const list = this.app.state.agenda.filter(a => { const d = a.fechaHora ? new Date(a.fechaHora) : null; return d && (this.app.uiState.filterAg==='Todos'||a.tipo===this.app.uiState.filterAg) && (this.app.uiState.historiaAgenda ? d<new Date() : d>=new Date().setHours(0,0,0,0)); }).sort((a,b)=>new Date(a.fechaHora)-new Date(b.fechaHora));
                const groups = {}; list.forEach(e => { const k = new Date(e.fechaHora).toLocaleDateString('es-AR', {weekday:'long',day:'numeric',month:'long'}); (groups[k]=groups[k]||[]).push(e); });
                document.getElementById('lista-agenda-grouped').innerHTML = Object.entries(groups).map(([d, items]) => `<div class="mb-6"><h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">${d}</h5><div class="space-y-3">${items.map(x => `<div onclick="window.App.Forms.openAgenda('${x.id}')" class="bg-white p-4 rounded-2xl shadow-sm border-l-[6px] ${x.tipo==='Audiencia'?'border-red-500':'border-brand'} flex justify-between cursor-pointer hover:shadow-md transition"><div class="flex gap-4"><div class="text-center w-12"><p class="font-bold text-lg text-slate-700 leading-none">${new Date(x.fechaHora).getHours()}:${String(new Date(x.fechaHora).getMinutes()).padStart(2,'0')}</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">${x.tipo.substr(0,3)}</p></div><div class="w-px bg-slate-100 h-8"></div><div><h4 class="font-bold text-sm text-slate-800">${x.cliente}</h4><p class="text-xs text-slate-400">${x.causa||'Evento'}</p></div></div><button onclick="event.stopPropagation(); window.App.Data.delete('agenda','${x.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`).join('')}</div></div>`).join('');
            }

            tareas() {
                const list = this.app.state.tareas.filter(t => !t.completada).sort((a,b) => (a.vencimiento?new Date(a.vencimiento):9e15)-(b.vencimiento?new Date(b.vencimiento):9e15));
                document.getElementById('lista-tareas').innerHTML = list.map(t => `<div onclick="window.App.Forms.openTarea('${t.id}')" class="bg-white p-5 rounded-3xl shadow-soft border-l-[6px] ${t.prioridad==='Alta'?'border-l-red-500':'border-l-indigo-500'} cursor-pointer group hover:shadow-lg transition"><div class="flex justify-between mb-3"><h4 class="font-bold text-slate-800 text-sm flex-1 leading-snug">${t.texto}</h4><button onclick="event.stopPropagation(); window.App.Data.delete('tareas','${t.id}')" class="text-slate-300 hover:text-red-500 ml-2 self-start"><i class="fa-solid fa-trash"></i></button></div><div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-50/50"><button onclick="event.stopPropagation(); window.App.Forms.toggleTareaCompletada('${t.id}')" class="text-xs text-slate-500 hover:text-brand font-bold flex items-center gap-1.5"><i class="fa-regular fa-circle"></i> Completar</button>${t.vencimiento ? `<div class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100 flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${t.vencimiento.split('-')[2]}/${t.vencimiento.split('-')[1]}</div>` : ''}</div></div>`).join('');
            }

            contactos() {
                const q = document.getElementById('buscar-contacto').value.toLowerCase();
                const showP = this.app.uiState.viewCt === 'personas';
                this.app.UI.toggleView('view-contactos-personas', showP); this.app.UI.toggleView('view-contactos-organismos', !showP);
                document.getElementById('btn-view-personas').className = showP ? "px-5 py-1.5 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm border border-slate-100" : "px-5 py-1.5 rounded-lg text-xs font-bold text-slate-500";
                document.getElementById('btn-view-organismos').className = !showP ? "px-5 py-1.5 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm border border-slate-100" : "px-5 py-1.5 rounded-lg text-xs font-bold text-slate-500";
                
                if (showP) {
                    let list = this.app.state.contactos.filter(x => !q || (x.nombre||'').toLowerCase().includes(q));
                    if (this.app.uiState.sortCt === 'AZ') list.sort((a,b) => a.nombre.localeCompare(b.nombre)); else list.sort((a,b) => (b.lastContactedAt||0)-(a.lastContactedAt||0));
                    document.getElementById('view-contactos-personas').innerHTML = list.map(c => `<div onclick="window.App.Forms.openContacto('${c.id}')" class="bg-white p-4 rounded-2xl shadow-sm cursor-pointer flex justify-between items-center hover:shadow-md transition"><div><p class="font-bold text-sm text-slate-800">${c.nombre}</p><p class="text-xs text-gray-400">${c.rol}</p></div><div class="flex gap-2">${c.email ? `<a href="mailto:${c.email}" onclick="event.stopPropagation(); window.App.Data.touchContact('contactos','${c.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition"><i class="fa-regular fa-envelope"></i></a>` : ''}${c.telefono ? `<a href="https://wa.me/${c.telefono.replace(/[^0-9]/g, '')}" target="_blank" onclick="event.stopPropagation(); window.App.Data.touchContact('contactos','${c.id}')" class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100 transition"><i class="fa-brands fa-whatsapp"></i></a>` : ''}</div></div>`).join('');
                } else { this.organismos(q); }
            }

            organismos(q = '') {
                const list = this.app.state.organismos.filter(x => !q || (x.nombre||'').toLowerCase().includes(q));
                if (this.app.uiState.sortCt === 'AZ') list.sort((a,b) => a.nombre.localeCompare(b.nombre)); else list.sort((a,b) => (b.lastContactedAt||0)-(a.lastContactedAt||0));
                document.getElementById('view-contactos-organismos').innerHTML = list.map(o => `<div onclick="window.App.Forms.openOrg('${o.id}')" class="bg-white p-4 rounded-2xl shadow-sm cursor-pointer flex justify-between items-center hover:shadow-md transition"><div><p class="font-bold text-sm text-slate-800">${o.nombre}</p><p class="text-xs text-gray-400">${o.tipo}</p></div><div class="flex gap-2 items-center">${o.email ? `<a href="mailto:${o.email}" onclick="event.stopPropagation(); window.App.Data.touchContact('organismos','${o.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition"><i class="fa-regular fa-envelope"></i></a>` : ''}${o.telefono ? `<a href="https://wa.me/${o.telefono.replace(/[^0-9]/g, '')}" target="_blank" onclick="event.stopPropagation(); window.App.Data.touchContact('organismos','${o.id}')" class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100 transition"><i class="fa-brands fa-whatsapp"></i></a>` : ''}<i class="fa-solid fa-building-columns text-slate-300 ml-2"></i></div></div>`).join('');
            }

            utiles() {
                const q = document.getElementById('buscar-util').value.toLowerCase(), type = document.getElementById('filter-utiles-tipo').value;
                const list = this.app.state.utiles.filter(u => (!q || u.titulo.toLowerCase().includes(q)) && (type==='Todos'||u.tipo===type));
                document.getElementById('lista-utiles').innerHTML = list.map(x => `<div class="bg-white p-4 rounded-2xl shadow-sm cursor-pointer hover:border-brand-light hover:shadow-md transition border border-transparent" onclick="window.App.Forms.openUtil('${x.id}')"><div class="flex justify-between"><h4 class="font-bold text-sm text-slate-700">${x.titulo}</h4><div class="flex gap-1"><button onclick="event.stopPropagation(); window.App.Utils.copyResourceContent('${x.id}')" class="text-slate-300 hover:text-indigo-500 p-1" title="Copiar"><i class="fa-regular fa-copy"></i></button><span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-400 font-bold self-center">${x.tipo}</span></div></div><p class="text-xs text-slate-400 mt-2 line-clamp-2">${x.contenido}</p></div>`).join('');
            }

            links() {
                const q = document.getElementById('buscar-link').value.toLowerCase();
                let list = this.app.state.links.filter(x => !q || (x.nombre||'').toLowerCase().includes(q));
                if (this.app.uiState.sortLinks === 'AZ') list.sort((a,b) => a.nombre.localeCompare(b.nombre)); else list.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
                document.getElementById('lista-links').innerHTML = list.map(x => `<div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center"><a href="${x.url}" target="_blank" class="font-bold text-slate-700 hover:text-brand">${x.nombre}</a><button onclick="window.App.Data.delete('links','${x.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            }

            movs() {
                const moves = this.app.state.movimientos.filter(x => x.caseId === this.app.uiState.curCase).sort((a,b) => b.date - a.date);
                document.getElementById('lista-movimientos').innerHTML = moves.filter(x => x.tag === 'novedad').map(n => `<div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><div class="flex justify-between mb-1"><span class="font-bold text-xs text-slate-800">${this.app.Utils.fmtDate(n.date)} - ${n.tipo}</span><div class="flex gap-2"><button onclick="window.App.Forms.editManualMov('${n.id}')" class="text-slate-300 hover:text-indigo-500"><i class="fa-solid fa-pen"></i></button><button onclick="window.App.Data.delete('movimientos','${n.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div><p class="text-xs text-slate-600 whitespace-pre-wrap">${n.resumen || n.desc}</p></div>`).join('');
                let ing=0, egr=0; 
                document.getElementById('lista-contable').innerHTML = moves.filter(x => x.tag === 'contable').map(c => { if(c.tipo==='Ingreso') ing+=c.monto; else egr+=c.monto; return `<div class="flex justify-between items-center bg-white p-2 border-b border-slate-50"><div onclick="window.App.Forms.editContaMov('${c.id}')" class="flex-1 cursor-pointer"><p class="text-xs font-bold text-slate-700">${c.desc}</p></div><span class="font-mono text-xs font-bold ${c.tipo==='Ingreso'?'text-emerald-600':'text-red-600'}">$${c.monto}</span><button onclick="window.App.Data.delete('movimientos','${c.id}')" class="ml-2 text-slate-200 hover:text-red-400"><i class="fa-solid fa-times"></i></button></div>`; }).join('');
                document.getElementById('conta-ingresos').innerText = `$${ing}`; document.getElementById('conta-egresos').innerText = `$${egr}`; document.getElementById('conta-balance').innerText = `$${ing-egr}`;
            }

            calendar() {
                const m = this.app.uiState.curMonth, y = this.app.uiState.curYear, monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                document.getElementById('alm-title').innerText = `${monthNames[m]} ${y}`;
                const first = new Date(y,m,1).getDay(), days = new Date(y,m+1,0).getDate();
                let html = ''; for(let i=0; i<first; i++) html+=`<div class="cal-day opacity-0"></div>`;
                for(let i=1; i<=days; i++) {
                    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const isHol = CONFIG.feriadosBase.includes(ds) || this.app.state.feriados.some(f => f.date === ds), isToday = new Date().toDateString() === new Date(y,m,i).toDateString();
                    html += `<div class="cal-day ${isToday?'today':''} ${isHol?'holiday':''}" onclick="window.App.UI.openDayView('${ds}')">${i}${this.app.state.feriados.some(f=>f.date===ds)?'<div class="holiday-dot"></div>':''}</div>`;
                }
                document.getElementById('alm-grid').innerHTML = html;
            }

            dayView(dateStr) {
                const dateObj = new Date(dateStr + "T00:00:00");
                const title = dateObj.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' });
                document.getElementById('day-view-title').innerText = title.charAt(0).toUpperCase() + title.slice(1);
                
                const btnHol = document.getElementById('btn-toggle-holiday');
                const isFixed = CONFIG.feriadosBase.includes(dateStr), isCustom = this.app.state.feriados.some(f => f.date === dateStr);
                
                if (isFixed) {
                    btnHol.innerText = "Feriado Nacional (Fijo)"; btnHol.className = "text-xs font-bold text-red-400 cursor-not-allowed uppercase tracking-wider"; btnHol.onclick = null;
                } else {
                    btnHol.innerText = isCustom ? "Desmarcar Feriado" : "Marcar como Feriado";
                    btnHol.className = `text-xs font-bold ${isCustom ? 'text-red-500' : 'text-slate-400'} hover:text-brand transition uppercase tracking-wider`;
                    btnHol.onclick = () => { this.app.Utils.toggleHoliday(dateStr); this.app.UI.closeModal('modal-day-view'); };
                }

                const agenda = this.app.state.agenda.filter(a => a.fechaHora && a.fechaHora.startsWith(dateStr)).map(e => ({...e, _type: 'agenda'}));
                const tareas = this.app.state.tareas.filter(t => t.vencimiento && t.vencimiento === dateStr && !t.completada).map(t => ({...t, _type: 'tarea'}));
                const mixed = [...agenda, ...tareas].sort((a, b) => {
                    const getT = (x) => { if (x._type === 'tarea') return 9999999999999; return x.fechaHora ? new Date(x.fechaHora).getTime() : 9999999999999; };
                    return (getT(a)||9e13) - (getT(b)||9e13);
                });
                
                document.getElementById('day-view-content').innerHTML = mixed.length ? mixed.map(x => {
                    if (x._type === 'agenda') {
                        return `<div onclick="window.App.UI.closeModal('modal-day-view'); window.App.Forms.openAgenda('${x.id}')" class="bg-slate-50 p-3 rounded-xl border border-slate-100 cursor-pointer hover:bg-white shadow-sm mb-2 group transition"><div class="flex justify-between items-center mb-1"><span class="font-bold text-slate-700 text-xs">${x.fechaHora.split('T')[1]}</span><span class="text-[9px] font-bold uppercase ${x.tipo==='Audiencia'?'text-red-500':'text-brand'} bg-white px-2 py-0.5 rounded border border-slate-100">${x.tipo}</span></div><p class="text-xs font-bold text-slate-800 truncate group-hover:text-brand transition">${x.cliente}</p><p class="text-[10px] text-slate-400 truncate">${x.causa || ''}</p></div>`;
                    } else {
                        return `<div onclick="window.App.UI.closeModal('modal-day-view'); window.App.Forms.openTarea('${x.id}')" class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 cursor-pointer hover:bg-indigo-50 shadow-sm mb-2 group transition"><div class="flex justify-between items-center mb-1"><span class="font-bold text-indigo-700 text-xs"><i class="fa-regular fa-clock mr-1"></i>Vence</span><span class="text-[9px] font-bold uppercase text-indigo-500 bg-white px-2 py-0.5 rounded border border-indigo-100">Tarea</span></div><p class="text-xs font-bold text-slate-800 truncate group-hover:text-indigo-600 transition">${x.texto}</p></div>`;
                    }
                }).join('') : '<p class="text-center text-slate-400 text-xs italic py-4">Sin eventos ni vencimientos.</p>';
            }
        }

        // M√ìDULO FORMULARIOS
        class FormsModule {
            constructor(app) { this.app = app; }
            fill(m,o) { Object.entries(m).forEach(([k,id]) => { const el = document.getElementById(id); if(el) el.value = o ? o[k] || '' : ''; }); }
            
            openCaso(id) {
                this.app.editState.caso = id; this.app.uiState.curCase = id; this.app.UI.switchCasoTab('datos');
                const d = id ? this.app.state.casos.find(x => x.id === id) : null;
                this.fill({caratula:'ca-caratula',cliente:'ca-cliente',cliente_tel:'ca-cliente-tel',expediente:'ca-expediente',juzgado:'ca-juzgado',paso:'ca-paso',contraparte:'ca-contraparte',abogado_contra:'ca-abogado-contra',abogado_email:'ca-abogado-email',abogado_tel:'ca-abogado-tel',auxiliar_nombre:'ca-auxiliar-nombre',auxiliar_tel:'ca-auxiliar-tel',auxiliar_email:'ca-auxiliar-email',driveLink:'ca-drive-link', encabezado: 'ca-encabezado'}, d);
                
                const populate = (l,f) => document.getElementById(l).innerHTML = [...new Set(this.app.state.casos.map(c => c[f]).filter(Boolean))].map(v => `<option value="${v}">`).join('');
                populate('list-contrapartes', 'contraparte'); populate('list-abogados', 'abogado_contra');

                document.getElementById('caso-modal-title').innerText = id ? (d.caratula||"Expediente") : "Nuevo Expediente";
                this.app.UI.toggleView('btn-borrar-caso', !!id);
                document.querySelectorAll('.conflict-alert').forEach(e => e.style.display = 'none');
                this.app.UI.toggleView('modal-caso', true);
                if(id) this.app.Render.movs(); else { document.getElementById('lista-movimientos').innerHTML=''; document.getElementById('lista-contable').innerHTML=''; }
            }

            saveCaso() {
                const data = { caratula:document.getElementById('ca-caratula').value, cliente:document.getElementById('ca-cliente').value, cliente_tel:document.getElementById('ca-cliente-tel').value, expediente:document.getElementById('ca-expediente').value, juzgado:document.getElementById('ca-juzgado').value, paso:document.getElementById('ca-paso').value, contraparte:document.getElementById('ca-contraparte').value, abogado_contra:document.getElementById('ca-abogado-contra').value, abogado_email:document.getElementById('ca-abogado-email').value, abogado_tel:document.getElementById('ca-abogado-tel').value, auxiliar_nombre:document.getElementById('ca-auxiliar-nombre').value, auxiliar_tel:document.getElementById('ca-auxiliar-tel').value, auxiliar_email:document.getElementById('ca-auxiliar-email').value, driveLink:document.getElementById('ca-drive-link').value, encabezado:document.getElementById('ca-encabezado').value, updatedAt:Date.now() };
                if(!data.caratula) return this.app.UI.toast("Falta Car√°tula",'error');
                if(data.cliente && !this.app.state.contactos.some(c=>c.nombre.toLowerCase()===data.cliente.toLowerCase())) this.app.Data.save('contactos',null,{nombre:data.cliente,telefono:data.cliente_tel,email:'',rol:'Cliente'},'Cliente guardado');
                this.app.Data.save('casos',this.app.editState.caso,data).then(()=>this.app.UI.closeModal('modal-caso'));
            }
            deleteCaso() { this.app.Data.delete('casos', this.app.editState.caso); this.app.UI.closeModal('modal-caso'); }

            openAgenda(id) {
                this.app.editState.agenda = id; const d = id ? this.app.state.agenda.find(x=>x.id===id) : null;
                this.fill({cliente:'ag-cliente',tipo:'ag-tipo',fechaHora:'ag-fecha',causa:'ag-causa',notas:'ag-notas'}, d);
                if(d){ if(d.modalidad){this.selectModalidad(d.modalidad); if(d.modalidad==='Virtual')document.getElementById('ag-ubicacion-virtual').value=d.ubicacion||''; else document.getElementById('ag-ubicacion-fisica').value=d.ubicacion||'';} else this.selectModalidad('Presencial'); } else { document.getElementById('ag-tipo').value='Audiencia'; this.selectModalidad('Presencial'); }
                this.toggleAgendaModalidad(); this.app.UI.toggleView('btn-borrar-agenda', !!id); this.app.UI.toggleView('modal-agenda', true);
            }
            saveAgenda() {
                const mod = document.getElementById('ag-mod-value').value;
                const loc = mod === 'Virtual' ? document.getElementById('ag-ubicacion-virtual').value : document.getElementById('ag-ubicacion-fisica').value;
                this.app.Data.save('agenda',this.app.editState.agenda,{cliente:document.getElementById('ag-cliente').value,tipo:document.getElementById('ag-tipo').value,fechaHora:document.getElementById('ag-fecha').value,causa:document.getElementById('ag-causa').value,notas:document.getElementById('ag-notas').value,modalidad:mod,ubicacion:loc}).then(()=>this.app.UI.closeModal('modal-agenda'));
            }
            deleteAgenda() { this.app.Data.delete('agenda',this.app.editState.agenda); this.app.UI.closeModal('modal-agenda'); }
            toggleAgendaModalidad() { const t = document.getElementById('ag-tipo').value; this.app.UI.toggleView('ag-modalidad-container', ['Audiencia','Reuni√≥n'].includes(t)); }
            selectModalidad(m) { document.getElementById('ag-mod-value').value=m; this.app.UI.toggleView('input-presencial',m==='Presencial'); this.app.UI.toggleView('input-virtual',m==='Virtual'); document.getElementById('mod-card-Presencial').classList.toggle('bg-slate-100',m==='Presencial'); document.getElementById('mod-card-Virtual').classList.toggle('bg-slate-100',m==='Virtual'); }

            addTaskQuick() { const i = document.getElementById('quick-task-input'); if(i.value) this.app.Data.save('tareas',null,{texto:i.value,prioridad:'Normal',completada:false,vencimiento:new Date().toISOString().split('T')[0]}).then(()=>i.value=''); }
            openTarea(id) { this.app.editState.tarea=id; const d=id?this.app.state.tareas.find(x=>x.id===id):null; this.fill({texto:'ta-texto',descripcion:'ta-descripcion',prioridad:'ta-prioridad',vencimiento:'ta-vencimiento'},d); if(!id)document.getElementById('ta-prioridad').value='Normal'; this.app.UI.toggleView('btn-borrar-tarea', !!id); this.app.UI.toggleView('modal-tarea-full',true); }
            saveTarea() { this.app.Data.save('tareas',this.app.editState.tarea,{texto:document.getElementById('ta-texto').value,descripcion:document.getElementById('ta-descripcion').value,prioridad:document.getElementById('ta-prioridad').value,vencimiento:document.getElementById('ta-vencimiento').value}).then(()=>this.app.UI.closeModal('modal-tarea-full')); }
            deleteTarea() { this.app.Data.delete('tareas',this.app.editState.tarea); this.app.UI.closeModal('modal-tarea-full'); }
            toggleTareaCompletada(id) { this.app.Data.delete('tareas',id); }

            newContactoBtn() { return this.app.uiState.viewCt==='personas' ? this.openContacto() : this.openOrg(); }
            openContacto(id) { this.app.editState.contacto=id; const d=id?this.app.state.contactos.find(x=>x.id===id):null; this.fill({nombre:'co-nombre',telefono:'co-telefono',email:'co-email',rol:'co-rol'},d); if(!id){document.getElementById('co-telefono').value='+54 9 ';document.getElementById('co-rol').value='Cliente';} document.getElementById('conflict-co').style.display='none'; this.app.UI.toggleView('btn-borrar-contacto', !!id); this.app.UI.toggleView('modal-contacto',true); }
            saveContacto() { this.app.Data.save('contactos',this.app.editState.contacto,{nombre:document.getElementById('co-nombre').value,telefono:document.getElementById('co-telefono').value,email:document.getElementById('co-email').value,rol:document.getElementById('co-rol').value}).then(()=>this.app.UI.closeModal('modal-contacto')); }
            deleteContacto() { this.app.Data.delete('contactos',this.app.editState.contacto); this.app.UI.closeModal('modal-contacto'); }
            openOrg(id) { this.app.editState.org=id; const d=id?this.app.state.organismos.find(x=>x.id===id):null; this.fill({nombre:'org-nombre',tipo:'org-tipo',telefono:'org-tel',email:'org-email',direccion:'org-direccion'},d); if(!id){document.getElementById('org-tel').value='+54 9 ';document.getElementById('org-tipo').value='Juzgado';} this.app.UI.toggleView('btn-borrar-org', !!id); this.app.UI.toggleView('modal-organismo',true); }
            saveOrg() { this.app.Data.save('organismos',this.app.editState.org,{nombre:document.getElementById('org-nombre').value,tipo:document.getElementById('org-tipo').value,telefono:document.getElementById('org-tel').value,email:document.getElementById('org-email').value,direccion:document.getElementById('org-direccion').value}).then(()=>this.app.UI.closeModal('modal-organismo')); }
            deleteOrg() { this.app.Data.delete('organismos',this.app.editState.org); this.app.UI.closeModal('modal-organismo'); }

            openLink(id) { this.app.UI.toggleView('modal-link',true); }
            saveLink() { this.app.Data.save('links',null,{nombre:document.getElementById('li-nombre').value,url:document.getElementById('li-url').value}).then(()=>this.app.UI.closeModal('modal-link')); }
            deleteLink() { } 
            openUtil(id, content, title) { 
                this.app.editState.util=id; 
                document.getElementById('ut-select-caso').innerHTML = '<option value="">-- Seleccionar Expediente --</option>' + this.app.state.casos.map(c=>`<option value="${c.id}">${c.caratula}</option>`).join('');
                let d = null; if(id) d = this.app.state.utiles.find(x=>x.id===id); else if(content) d = { titulo: title || 'Borrador IA', contenido: content, tipo: 'Escrito' };
                this.fill({titulo:'ut-titulo',contenido:'ut-contenido',tipo:'ut-tipo'}, d); 
                this.app.UI.toggleView('btn-borrar-util', !!id); this.app.UI.toggleView('modal-util',true); 
            }
            saveUtil() { this.app.Data.save('utiles',this.app.editState.util,{titulo:document.getElementById('ut-titulo').value,contenido:document.getElementById('ut-contenido').value,tipo:document.getElementById('ut-tipo').value}).then(()=>this.app.UI.closeModal('modal-util')); }
            deleteUtil() { this.app.Data.delete('utiles',this.app.editState.util); this.app.UI.closeModal('modal-util'); }
            insertVar(t) { const el=document.getElementById('ut-contenido'); const [s,e]=[el.selectionStart,el.selectionEnd]; el.value=el.value.substring(0,s)+t+el.value.substring(e); }

            saveManualMov() { if(!this.app.uiState.curCase)return; const f = document.getElementById('man-mov-fecha').value; this.app.Data.save('movimientos',this.app.editState.movMan,{caseId:this.app.uiState.curCase,tag:'novedad',date:f?new Date(f+'T00:00:00').getTime():Date.now(),tipo:document.getElementById('man-mov-tipo').value,desc:document.getElementById('man-mov-desc').value}).then(()=>{this.app.Data.touchCase(this.app.uiState.curCase); this.app.editState.movMan=null; document.getElementById('man-mov-desc').value=''; document.getElementById('btn-save-manual-mov').innerText="Agregar"; this.app.UI.toggleView('btn-cancel-manual-mov', false); this.app.Render.movs();}); }
            cancelManualMov() { this.app.editState.movMan=null; document.getElementById('man-mov-desc').value=''; document.getElementById('btn-save-manual-mov').innerText="Agregar"; this.app.UI.toggleView('btn-cancel-manual-mov', false); }
            editManualMov(id) { const m = this.app.state.movimientos.find(x=>x.id===id); if(!m)return; this.app.editState.movMan=id; const d=new Date(m.date); document.getElementById('man-mov-fecha').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; document.getElementById('man-mov-tipo').value=m.tipo; document.getElementById('man-mov-desc').value=m.desc||m.resumen; document.getElementById('btn-save-manual-mov').innerText="Guardar"; this.app.UI.toggleView('btn-cancel-manual-mov', true); }
            addContaMov() { const d=document.getElementById('new-mov-desc').value, m=document.getElementById('new-mov-monto').value; if(d&&m) this.app.Data.save('movimientos',this.app.editState.mov,{caseId:this.app.uiState.curCase,tag:'contable',desc:d,monto:parseFloat(m),tipo:document.getElementById('new-mov-tipo').value}).then(()=>{this.app.Data.touchCase(this.app.uiState.curCase); this.app.editState.mov=null; document.getElementById('new-mov-desc').value=''; this.app.Render.movs();}); }
            editContaMov(id) { const m = this.app.state.movimientos.find(x=>x.id===id); if(m){this.app.editState.mov=id; document.getElementById('new-mov-desc').value=m.desc; document.getElementById('new-mov-monto').value=m.monto; document.getElementById('new-mov-tipo').value=m.tipo; document.getElementById('btn-save-conta').innerText="Guardar"; document.getElementById('new-mov-desc').focus();} }
        }

        // M√ìDULO INTELIGENCIA ARTIFICIAL (JUSTINA)
        class IAModule {
            constructor(app) {
                this.app = app;
                this.systemPrompt = `Eres Justina, secretaria legal. Analiza el input y responde SOLO JSON sin formato markdown.
                FORMATOS JSON:
                1. AGENDAR: {"action":"agenda","data":{"tipo":"Audiencia|Vencimiento|Reuni√≥n|Otro","cliente":"Nombre","fecha":"YYYY-MM-DDTHH:MM","causa":"(opc)","notas":"(opc)"}}
                2. TAREA: {"action":"tarea","data":{"texto":"Desc","vencimiento":"YYYY-MM-DD","prioridad":"Normal|Alta"}}
                3. EMAIL: {"action":"email","data":{"name":"Nombre","subject":"Asunto","body":"Cuerpo"}}
                4. WHATSAPP: {"action":"whatsapp","data":{"name":"Nombre","message":"Texto"}}
                5. REDACTAR: {"action":"redactar","data":{"caseQuery":"Nombre caso","instruction":"Qu√© escribir"}}
                IMPORTANTE: NO usar bloques de c√≥digo (\`\`\`json). Devolver solo la cadena JSON plana.`;
            }

            async testConnection() {
                const key = localStorage.getItem(STORAGE_KEY_API); if (!key) return this.app.UI.toast("Falta API Key", 'error');
                try { this.app.UI.toggleLoader('justina-loader', true); await this.callGemini(key, "Hola"); this.app.UI.toast("Conectado"); } 
                catch (e) { this.app.UI.toast(`Error IA: ${e.message}`, 'error'); } finally { this.app.UI.toggleLoader('justina-loader', false); }
            }

            async processCommand() {
                const i = document.getElementById('justina-input'), text = i.value.trim(), key = localStorage.getItem(STORAGE_KEY_API);
                if (!text || !key) return this.app.UI.toast("Falta texto o Key", 'error');
                document.getElementById('justina-icon').classList.add('hidden'); document.getElementById('justina-loader').classList.remove('hidden'); i.disabled = true;

                try {
                    const res = await this.callGemini(key, `${this.systemPrompt} INPUT: "${text}"`);
                    const result = this.parseGeminiResponse(res);
                    const actions = {
                        'agenda': async (d) => { await this.app.Data.save('agenda', null, d); if(d.tipo==='Audiencia'||d.tipo==='Vencimiento') await this.app.Data.save('tareas',null,{texto:`Prep: ${d.tipo} - ${d.cliente}`,vencimiento:d.fecha?d.fecha.split('T')[0]:'',prioridad:'Alta',completada:false}); },
                        'tarea': async (d) => this.app.Data.save('tareas', null, { ...d, completada: false }),
                        'email': (d) => this.handleCom(d, 'email'),
                        'whatsapp': (d) => this.handleCom(d, 'whatsapp'),
                        'redactar': (d) => this.handleDraft(d, key)
                    };
                    if (actions[result.action]) { await actions[result.action](result.data); i.value = ''; } else this.app.UI.toast("Acci√≥n desconocida", 'error');
                } catch (e) { this.app.UI.toast(`Error: ${e.message}`, 'error'); } 
                finally { document.getElementById('justina-icon').classList.remove('hidden'); document.getElementById('justina-loader').classList.add('hidden'); i.disabled = false; i.focus(); }
            }

            async callGemini(key, prompt) {
                // ESTRATEGIA: Flash (R√°pido) -> Pro (Potente) -> 1.0 (Legacy)
                const models = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-1.0-pro"];
                let lastError = null;
                
                for (const model of models) {
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                        });
                        
                        if (r.status === 404 || r.status === 429) { console.warn(`Modelo ${model} fall√≥ con ${r.status}`); continue; }
                        if (!r.ok) { const errData = await r.json(); throw new Error(`Error ${r.status}: ${errData.error?.message || r.statusText}`); }
                        
                        const d = await r.json(); 
                        if (!d.candidates || !d.candidates[0]) throw new Error("Sin respuesta de IA");
                        return d.candidates[0].content.parts[0].text;
                    } catch (e) {
                        lastError = e;
                        if(e.message.includes('404') || e.message.includes('429')) continue;
                        throw e; 
                    }
                }
                throw lastError || new Error("No se pudo conectar con ning√∫n modelo.");
            }

            parseGeminiResponse(txt) {
                try { return JSON.parse(txt); } 
                catch (e) {
                    // Limpieza agresiva por si la IA devuelve markdown
                    let clean = txt.replace(/```json/g, '').replace(/```/g, '').trim();
                    const s = clean.indexOf('{'), e2 = clean.lastIndexOf('}');
                    if (s !== -1 && e2 !== -1) return JSON.parse(clean.substring(s, e2 + 1));
                    throw new Error("Formato inv√°lido");
                }
            }

            findContact(q) {
                if (!q) return null; const clean = q.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const all = [...this.app.state.contactos, ...this.app.state.organismos];
                const res = all.map(c => {
                    const n = c.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    return { c, score: n === clean ? 100 : (n.includes(clean) ? 80 : 0) };
                }).filter(x => x.score > 0).sort((a, b) => b.score - a.score);
                return res.length ? res[0].c : null;
            }

            handleCom(d, type) {
                const c = this.findContact(d.name);
                if (!c) return this.app.UI.toast(`No encontr√© a "${d.name}"`, 'error');
                if (type === 'email') { if(!c.email) return this.app.UI.toast("Sin email", 'error'); location.href = `mailto:${c.email}?subject=${encodeURIComponent(d.subject||'')}&body=${encodeURIComponent(d.body||'')}`; }
                else { if(!c.telefono) return this.app.UI.toast("Sin tel√©fono", 'error'); window.open(`https://wa.me/${c.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(d.message||'')}`, '_blank'); }
            }

            async handleDraft(d, key) {
                const c = this.app.state.casos.find(x => (x.caratula+" "+x.cliente).toLowerCase().includes(d.caseQuery.toLowerCase()));
                const prompt = `Act√∫a como Abogado Senior en Provincia de Buenos Aires. ${c ? `Contexto del Caso: Car√°tula ${c.caratula}, Juzgado ${c.juzgado}, Exp ${c.expediente}. ${c.encabezado ? `ENCABEZADO OBLIGATORIO: "${c.encabezado}"` : ''}` : 'Contexto Gen√©rico'}. TAREA: Redactar escrito jur√≠dico sobre: "${d.instruction}". FORMATO: Solo el texto del escrito listo para copiar y pegar.`;
                try { const txt = await this.callGemini(key, prompt); this.app.Forms.openUtil(null, txt, `Escrito ${c ? c.caratula : ''}`); } catch(e){ this.app.UI.toast(`Error redactando: ${e.message}`, 'error'); }
            }

            toggleVoice() {
                if (!('webkitSpeechRecognition' in window)) return this.app.UI.toast("Navegador no soporta voz", 'error');
                if (this.rec && this.list) { this.rec.stop(); return; }
                this.rec = new webkitSpeechRecognition(); this.rec.lang = 'es-AR'; this.rec.interimResults = false;
                this.rec.onstart = () => { this.list = true; document.getElementById('justina-mic-icon').classList.add('voice-active'); document.getElementById('justina-input').placeholder = "Escuchando..."; };
                this.rec.onend = () => { this.list = false; document.getElementById('justina-mic-icon').classList.remove('voice-active'); document.getElementById('justina-input').placeholder = "Escribe..."; };
                this.rec.onresult = (e) => { document.getElementById('justina-input').value = e.results[0][0].transcript; setTimeout(() => this.processCommand(), 500); };
                this.rec.start();
            }

            async morningBrief() {
                const key = localStorage.getItem(STORAGE_KEY_API); if (!key) return this.app.UI.toast("Falta Key", 'error');
                const box = document.getElementById('morning-brief-container'), txt = document.getElementById('morning-brief-content');
                box.classList.remove('hidden'); txt.innerHTML = 'Justina est√° pensando...';
                const today = new Date().toISOString().split('T')[0];
                const ev = this.app.state.agenda.filter(a => a.fechaHora && a.fechaHora.startsWith(today));
                try { const res = await this.callGemini(key, `Soy el Dr. Patricio Van Meegroot. Hoy ${today}. Tengo ${ev.length} eventos en agenda. Dame un resumen motivador y profesional.`); txt.innerText = res; } catch(e){ txt.innerText = "Error obteniendo resumen."; }
            }
        }

        // UTILS
        class UtilsModule {
            constructor(app) { this.app = app; }
            togglePass(id) { const el=document.getElementById(id); el.type=el.type==='password'?'text':'password'; }
            fmtDate(ts) { return new Date(ts).toLocaleDateString('es-AR',{day:'2-digit',month:'short'}); }
            
            // BUSCADOR GLOBAL MEJORADO
            globalSearch() {
                const q = document.getElementById('global-search').value.toLowerCase();
                const container = document.getElementById('search-results');
                
                // Si escribiste menos de 2 letras, ocultamos todo
                if(q.length < 2){ container.classList.add('hidden'); return; }

                let html = '';
                
                // 1. Buscar en CASOS (Expedientes)
                const casos = this.app.state.casos.filter(x => (x.caratula + x.cliente + x.expediente).toLowerCase().includes(q));
                if(casos.length) {
                    html += `<div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 rounded mb-1">Expedientes</div>`;
                    casos.forEach(x => {
                        html += `<div onclick="window.App.Forms.openCaso('${x.id}');window.App.Utils.clearSearch()" class="p-2 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-2 group transition"><div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center group-hover:bg-brand group-hover:text-white transition"><i class="fa-solid fa-folder-open"></i></div><div class="overflow-hidden"><p class="text-xs font-bold text-slate-700 truncate">${x.caratula}</p><p class="text-[10px] text-slate-400 truncate">${x.cliente}</p></div></div>`;
                    });
                }

                // 2. Buscar en CONTACTOS
                const contactos = this.app.state.contactos.filter(x => x.nombre.toLowerCase().includes(q));
                if(contactos.length) {
                    html += `<div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 rounded mb-1 mt-2">Personas</div>`;
                    contactos.forEach(x => {
                        html += `<div onclick="window.App.UI.changeTab('contactos');window.App.Forms.openContacto('${x.id}');window.App.Utils.clearSearch()" class="p-2 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-2 group transition"><div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition"><i class="fa-solid fa-user"></i></div><div class="overflow-hidden"><p class="text-xs font-bold text-slate-700 truncate">${x.nombre}</p><p class="text-[10px] text-slate-400 truncate">${x.telefono || 'Sin tel'}</p></div></div>`;
                    });
                }

                // 3. Buscar en TAREAS (¬°Nuevo!)
                const tareas = this.app.state.tareas.filter(t => t.texto.toLowerCase().includes(q) && !t.completada);
                if(tareas.length) {
                    html += `<div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 rounded mb-1 mt-2">Tareas</div>`;
                    tareas.forEach(x => {
                        html += `<div onclick="window.App.UI.changeTab('tareas');window.App.Forms.openTarea('${x.id}');window.App.Utils.clearSearch()" class="p-2 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-2 group transition"><div class="w-8 h-8 rounded-full bg-amber-50 text-amber-500 flex items-center justify-center group-hover:bg-amber-500 group-hover:text-white transition"><i class="fa-solid fa-list-check"></i></div><p class="text-xs font-bold text-slate-700 truncate">${x.texto}</p></div>`;
                    });
                }

                // 4. Buscar en AGENDA (¬°Nuevo!)
                const agenda = this.app.state.agenda.filter(a => (a.cliente + a.tipo).toLowerCase().includes(q));
                if(agenda.length) {
                    html += `<div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 rounded mb-1 mt-2">Agenda</div>`;
                    agenda.forEach(x => {
                        html += `<div onclick="window.App.UI.changeTab('agenda');window.App.Forms.openAgenda('${x.id}');window.App.Utils.clearSearch()" class="p-2 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-2 group transition"><div class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition"><i class="fa-regular fa-calendar"></i></div><div><p class="text-xs font-bold text-slate-700 truncate">${x.cliente}</p><p class="text-[10px] text-slate-400">${this.fmtDate(x.fechaHora)}</p></div></div>`;
                    });
                }

                // Si no hay nada
                if(!html) {
                    html = `<div class="p-4 text-center"><p class="text-xs text-slate-400 italic">No se encontraron resultados para "${q}"</p></div>`;
                }

                container.innerHTML = html;
                container.classList.remove('hidden');
            }

            clearSearch() { 
                document.getElementById('global-search').value=''; 
                document.getElementById('search-results').classList.add('hidden'); 
            }

            checkConflicts(id, aid) { const v=document.getElementById(id).value.toLowerCase(), a=document.getElementById(aid); if(v.length<3){a.classList.add('hidden');return;} const c=[]; this.app.state.casos.forEach(x=>{if(x.cliente.toLowerCase().includes(v)||x.contraparte?.toLowerCase().includes(v))c.push(x.caratula)}); if(c.length){a.classList.remove('hidden'); a.innerText="Coincide con: "+c.slice(0,3).join(', ');} else a.classList.add('hidden'); }
            openDriveLinkFromInput(id) { const v=document.getElementById(id).value; if(v) window.open(v.startsWith('http')?v:'https://'+v,'_blank'); }
            openVirtualLinkFromInput(id) { this.openDriveLinkFromInput(id); }
            searchInMaps(id) { const v=document.getElementById(id).value; if(v) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v)}`,'_blank'); }
            whatsappCliente() { const v=document.getElementById('ca-cliente-tel').value; if(v) window.open(`https://wa.me/${v.replace(/[^0-9]/g,'')}`,'_blank'); }
            printModel() { const w=window.open('','_blank'); w.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${document.getElementById('ut-contenido').value}</pre>`); w.print(); w.close(); }
            changeMonth(d) { this.app.uiState.curMonth+=d; if(this.app.uiState.curMonth>11){this.app.uiState.curMonth=0;this.app.uiState.curYear++;} if(this.app.uiState.curMonth<0){this.app.uiState.curMonth=11;this.app.uiState.curYear--;} this.app.Render.calendar(); }
            toggleHoliday(d) { if(CONFIG.feriadosBase.includes(d))return; const e=this.app.state.feriados.find(x=>x.date===d); if(e)this.app.db.collection('feriados').doc(e.id).delete().then(()=>this.app.Render.calendar()); else this.app.db.collection('feriados').add({uid:this.app.state.user.uid,date:d}).then(()=>this.app.Render.calendar()); }
            calculateDeadline() {
                const s=document.getElementById('calc-inicio').value, days=parseInt(document.getElementById('calc-dias').value); if(!s||isNaN(days))return;
                let c=new Date(s+"T00:00:00"), cnt=0; c.setDate(c.getDate()+1);
                const isBiz = (d) => { const x=d.toISOString().split('T')[0]; return d.getDay()!==0 && d.getDay()!==6 && !CONFIG.feriadosBase.includes(x) && !this.app.state.feriados.some(f=>f.date===x); };
                while(cnt<days) { if(isBiz(c))cnt++; if(cnt<days)c.setDate(c.getDate()+1); } while(!isBiz(c))c.setDate(c.getDate()+1);
                document.getElementById('calc-resultado').classList.remove('hidden'); document.getElementById('res-fecha').innerText = c.toLocaleDateString('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            }
            copyResourceContent(id) { const res = this.app.state.utiles.find(u => u.id === id); if (res) { const el = document.createElement('textarea'); el.value = res.contenido; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); this.app.UI.toast("Copiado"); } }
            addToGoogleCalendar() {
                const cliente = document.getElementById('ag-cliente').value, fecha = document.getElementById('ag-fecha').value; 
                if(!cliente || !fecha) return this.app.UI.toast("Faltan datos", 'error');
                const start = new Date(fecha), end = new Date(start.getTime() + 60*60*1000);
                const fmt = (d) => d.toISOString().replace(/-|:|\.\d+/g, ""); 
                const title = encodeURIComponent(cliente + " - " + document.getElementById('ag-tipo').value);
                const details = encodeURIComponent(document.getElementById('ag-notas').value || "Agendado desde Justina");
                const loc = encodeURIComponent(document.getElementById('ag-mod-value').value === 'Virtual' ? (document.getElementById('ag-ubicacion-virtual').value || 'Virtual') : (document.getElementById('ag-ubicacion-fisica').value || ''));
                window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${fmt(start)}/${fmt(end)}&details=${details}&location=${loc}`, '_blank');
            }
        }

        window.onload = () => { window.App = new LegalApp(); };
    </script>
</body>
</html>